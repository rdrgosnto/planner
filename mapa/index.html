<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>
<style>
body{font-family:Arial;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.8);transform-origin:top center;display:none}
.bus-container{padding:20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center;justify-items:center}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer;user-select:none}
.seat.selected,.seat.mine{background:#e74c3c;border-color:#e74c3c;cursor:default}
.seat.white,.seat.lost-temp{color:transparent!important;cursor:default!important;pointer-events:none!important}
.seat.white{background:#fff!important;border:3px solid #8c96b2!important}
.seat.lost-temp{background:#aaa!important;border-color:#777!important}
.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}
.empty{background:0 0}
#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:#0001;z-index:9999}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .1s linear}
#confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;position:absolute;bottom:-64px;right:20px}
#cursoBox{position:absolute;top:60px;left:100%;width:40px;height:122px;background:#4CAF50;color:#fff;font-weight:bold;display:flex;align-items:center;justify-content:center}
#cursoText{transform:rotate(-90deg);font-size:18px;white-space:nowrap}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
const q=s=>document.querySelector(s),
      n=c=>c?.toString().replace(/\D/g,"").padStart(11,"0")||"",
      g=(o,...a)=>{for(const x of a){const k=Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());if(k)return o[k]}};

let sel=null,bl=[],us=[],cpf=null,curso="",layout=[],lock=false;

const GET="SUA_URL_GET_AQUI";

const anim=t=>{
  let w=parseFloat(q("#progress-bar").style.width)||0;
  (function s(){w<t?(w++,q("#progress-bar").style.width=w+"%",requestAnimationFrame(s)):0})();
};

/* ðŸ”’ FETCH BLINDADO */
const f=async(u,c)=>{
  try{
    const r=await fetch(u,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({cpf:c})
    });

    const text=await r.text();
    let data={};

    if(text){
      try{ data=JSON.parse(text); }catch{}
    }

    return{ok:r.ok,status:r.status,data};
  }catch{
    return{ok:false,status:0,data:{}};
  }
};

const render=l=>{
  let w=q(".bus-container");
  w.querySelector(".grid")?.remove();
  let g=document.createElement("div");
  g.className="grid";
  l.forEach(r=>r.forEach(v=>{
    let e=document.createElement("div");
    e.className=v===null?"empty":"seat";
    if(v){
      e.textContent=v.toString().padStart(2,"0");
    }
    g.appendChild(e);
  }));
  w.appendChild(g);
};

const load=async()=>{
  cpf=n(sessionStorage.getItem("cpf"));
  if(!cpf){ alert("CPF ausente"); return; }

  anim(30);

  let r=await f(GET,cpf);
  if(!r.ok){ alert("Erro ao consultar fluxo"); return; }

  let data=r.data||{};
  let cursos=data.cursos||data.codigo||[];

  let a=cursos.find(x=>n(g(x,"CPF","CPF2"))===cpf);

  /* âš ï¸ NÃƒO BLOQUEIA O MAPA */
  if(!a){
    alert("CPF nÃ£o autorizado ainda. Tente novamente.");
    return;
  }

  curso=g(a,"CODIGO","codigo","Curso").toUpperCase();
  q("#cursoText").textContent=curso;

  let cfg=await fetch("../configs/0046.json").then(r=>r.json());
  layout=cfg.layout;

  render(layout);
  anim(100);

  q("#progress-bar-container").remove();
  q("#bus-wrapper").style.display="block";
};

load();
</script>

</body>
</html>
