<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Planner | Mapa</title>

<style>
body{
  font-family:Arial,sans-serif;
  margin:0;padding:0;
  display:flex;flex-direction:column;
  min-height:100vh;
  justify-content:center;
  background:#fff;
}

#bus-wrapper{
  transform:scale(.9);
  transform-origin:top center;
  display:none;
}

.bus-container{
  padding:20px;
  border:3px solid #b0b0b0;
  border-radius:16px;
  width:fit-content;
  margin:20px auto;
  position:relative;
  display:flex;justify-content:center;
}

.grid{
  display:grid;
  grid-template-columns:repeat(5,54px);
  column-gap:10px;
  row-gap:14px;
  justify-content:center;
  justify-items:center;
}

.seat, .empty{
  width:54px;height:54px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  position:relative;
}

/* ---- POLTRONA NORMAL (VERDE) ---- */
.seat{
  background:#4CAF50;
  border:3px solid #4CAF50;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}

/* Travesseiro das poltronas normais */
.seat::after{
  content:"";
  position:absolute;
  bottom:-8px;
  left:50%;
  transform:translateX(-50%);
  width:32px;height:14px;
  border-radius:8px;
  background:#fff;
  border:3px solid #8c96b2;
}

/* ---- POLTRONA BRANCA (INSTRUTOR) ---- */
.seat.white{
  background:#fff !important;
  border:3px solid #8c96b2 !important;
  color:transparent !important;
  cursor:default;
}

/* Travesseiro branco com borda azul */
.seat.white::after{
  border-color:#8c96b2 !important;
}

/* Quando poltrona branca estiver bloqueada — aparência NÃO muda */
.seat.white.blocked{
  background:#fff !important;
  border:3px solid #8c96b2 !important;
  color:transparent !important;
  cursor:not-allowed !important;
}

/* ---- POLTRONA BLOQUEADA (NORMAL CINZA) ---- */
.seat.blocked{
  background:#6b6b6b;
  border-color:#6b6b6b;
  color:#fff !important;
  cursor:not-allowed;
}

/* ---- POLTRONA SELECIONADA (VERMELHA) ---- */
.seat.selected{
  background:#e74c3c;
  border-color:#e74c3c;
}

.empty{background:transparent}

/* Barra de progresso */
#progress-bar-container{
  position:fixed;
  bottom:0;left:0;
  width:100%;height:8px;
  background:rgba(0,0,0,.1);
  z-index:9999;
}
#progress-bar{
  width:0;height:100%;
  background:#4CAF50;
  transition:width .1s linear;
}

/* Botão confirmar */
#confirmarBtn{
  width:112px;height:54px;
  background:#4CAF50;
  color:#fff;border:none;
  font-size:16px;font-weight:bold;
  border-radius:12px;
  cursor:pointer;
  position:absolute;
  bottom:-64px;right:20px;
}

/* Caixa do curso lateral */
#cursoBox{
  position:absolute;
  top:60px;left:100%;
  width:40px;height:122px;
  background:#4CAF50;
  color:#fff;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  overflow:hidden;
  border:0;
  pointer-events:none;
}
#cursoText{
  transform:rotate(-90deg);
  font-size:18px;
  white-space:nowrap;
  line-height:1;
}
</style>
</head>

<body>
<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
const q=(s,d=document)=>d.querySelector(s);

let sel=null, rb=[], bl=[], currentUserCPF=null, currentCurso="", currentBus="";

const courseBusMap={AAL:"0046",ALI:"0046",QUI:"0046"};

const GET_ENDPOINT="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";
const POST_ENDPOINT="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/478aac5453024f5cb3d3b26495d9b7e0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=H6EQYc3xSSZazBjzf0vB_9u5QtwLNj_hnuoBM9CWgz0";

const fJSON=async u=>{
  try{
    const r=await fetch(u);
    return r.ok?await r.json():null;
  }catch{return null;}
};

/* CPF validation */
const vCPF=cpf=>{
  cpf=cpf.replace(/\D/g,'').padStart(11,'0');
  if(cpf.length!==11||/^(\d)\1+$/.test(cpf))return false;
  let s=0;
  for(let i=0;i<9;i++)s+=cpf[i]*(10-i);
  let r=(s*10)%11; if(r==10)r=0;
  if(r!=cpf[9])return false;
  s=0;
  for(let i=0;i<10;i++)s+=cpf[i]*(11-i);
  r=(s*10)%11; if(r==10)r=0;
  return r==cpf[10];
};

/* CPF prompt */
const pedirCPF=()=>{
  const salvo=sessionStorage.getItem("cpf");
  if(salvo&&vCPF(salvo)){ currentUserCPF=salvo; return salvo; }

  let cpf=null;
  while(true){
    cpf=prompt("Digite seu CPF (somente números)");
    if(cpf===null)return null;
    cpf=cpf.replace(/\D/g,"").padStart(11,"0");
    if(vCPF(cpf))break;
    alert("CPF inválido.");
  }
  sessionStorage.setItem("cpf",cpf);
  currentUserCPF=cpf;
  return cpf;
};

/* Criação da poltrona */
const cSeat=v=>{
  const e=document.createElement("div");

  if(v===null){
    e.className="empty";
  } 
  else if(v==="white"){
    e.className="seat white";
  } 
  else {
    e.className="seat";
    e.textContent=v.toString().padStart(2,"0");
  }
  return e;
};

/* Progress bar animation */
const animProg=t=>{
  let w=parseFloat(q("#progress-bar").style.width)||0;
  const step=()=>{if(w<t){w+=.5;q("#progress-bar").style.width=w+"%";requestAnimationFrame(step);}};
  step();
};

/* Render grid */
const renderGrid=layout=>{
  const wrap=q(".bus-container");
  wrap.querySelector(".grid")?.remove();
  const g=document.createElement("div"); 
  g.className="grid";

  layout.flat().forEach(v=>{
    const e=cSeat(v);

    if(v!==null && v!=="white"){
      const n=v.toString().padStart(2,"0");
      if(bl.includes(n)){
        e.classList.add("blocked");
      } else {
        e.onclick=()=>select(e);
      }
    }

    g.appendChild(e);
  });

  wrap.appendChild(g);
};

/* Select seat */
const select=e=>{
  if(e.classList.contains("blocked"))return;
  if(e.classList.contains("white"))return;
  if(e.classList.contains("selected")){
    e.classList.remove("selected"); sel=null;
  } else {
    sel?.classList.remove("selected");
    e.classList.add("selected");
    sel=e;
  }
};

const getFieldIgnoreCase=(obj,...names)=>{
  const ks=Object.keys(obj||{});
  for(const n of names){
    const k=ks.find(x=>x.toLowerCase()===n.toLowerCase());
    if(k)return obj[k];
  }
};

const renderSeats=async()=>{
  const cpf=pedirCPF();
  if(!cpf)return;

  animProg(20);
  const res=await fJSON(GET_ENDPOINT);
  if(!res)return alert("Erro ao consultar dados.");

  const lista=res.poltronas||res.lista||[];
  const codigos=res.codigo||res.cursos||[];

  animProg(50);

  const nCPF=v=>v?v.toString().replace(/\D/g,'').padStart(11,'0'):'';
  const aluno=codigos.find(r=>nCPF(getFieldIgnoreCase(r,"CPF2","CPF"))===cpf);

  if(!aluno)return alert("CPF não encontrado.");

  const cursoVal=getFieldIgnoreCase(aluno,"CODIGO","Codigo","codigo");
  if(!cursoVal)return alert("Usuário sem código/turma.");

  currentCurso=cursoVal.toString().trim().toUpperCase();
  currentBus=courseBusMap[currentCurso]||"0046";
  q("#cursoText").textContent=currentCurso;

  animProg(70);

  /* CORREÇÃO IMPORTANTE DE CAMINHO */
  const cfg=await fJSON(`../configs/${currentBus}.json`);
  if(!cfg)return alert("Erro ao carregar layout.");

  const cursoRows=lista.filter(x=>{
    const cv=getFieldIgnoreCase(x,"CURSO","Curso","curso");
    return cv&&cv.toString().trim().toUpperCase()===currentCurso;
  });

  bl=[...new Set(cursoRows.map(x=>{
    const id=getFieldIgnoreCase(x,"ID","Id","id");
    return id?id.toString().padStart(2,"0"):null;
  }).filter(Boolean))];

  rb=cursoRows.map(x=>{
    const c=getFieldIgnoreCase(x,"CPF2","Cpf2","cpf2","CPF","cpf");
    return c?c.toString().replace(/\D/g,'').padStart(11,'0'):null;
  }).filter(Boolean);

  animProg(100);
  renderGrid(cfg.layout);

  setTimeout(()=>q("#progress-bar-container").remove(),600);
  q("#bus-wrapper").style.display="block";
};

/* Enviar seleção */
q("#confirmarBtn").onclick=async()=>{
  if(!sel)return alert("Selecione uma poltrona");
  if(rb.includes(currentUserCPF))return alert("Usuário já possui reserva.");

  const body={poltrona:sel.textContent,CURSO:currentCurso,cpf:currentUserCPF};

  try{
    const r=await fetch(POST_ENDPOINT,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });

    if(r.ok){
      alert("Poltrona selecionada!");
      setTimeout(()=>location.reload(),2500);
    }else alert("Erro ao enviar reserva.");
  }catch{
    alert("Erro de comunicação.");
  }
};

renderSeats();
</script>
</body>
</html>
