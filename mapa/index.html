<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<script>
if(location.pathname.endsWith("index.html")){
  location.replace(location.pathname.replace("index.html",""));
}
</script>

<style>
body {
  font-family: Arial;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  justify-content: center;
  background: #fff;
}
#bus-wrapper {transform: scale(.9); transform-origin: top center; display: none;}
.bus-container {
  padding: 20px;
  border: 3px solid #b0b0b0;
  border-radius: 16px;
  width: fit-content;
  margin: 20px auto;
  position: relative;
  display: flex;
  justify-content: center;
}
.grid {
  display: grid;
  grid-template-columns: repeat(5, 54px);
  gap: 14px 10px;
  justify-content: center;
  justify-items: center;
}
.seat, .empty {
  width: 54px;
  height: 54px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  position: relative;
}
.seat {
  background: #4CAF50;
  border: 3px solid #4CAF50;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
}
.seat::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 32px;
  height: 14px;
  border-radius: 8px;
  background: #fff;
  border: 3px solid #8c96b2;
}
.seat.white {
  background: #fff!important;
  border: 3px solid #8c96b2!important;
  color: transparent!important;
  cursor: default!important;
  pointer-events: none!important;
}
.seat.white::after {border-color: #8c96b2!important;}
.seat.selected {background: #e74c3c; border-color: #e74c3c;}
.empty {background: 0 0;}
#confirmarBtn {
  width: 112px;
  height: 54px;
  background: #4CAF50;
  color: #fff;
  border: none;
  font-size: 16px;
  font-weight: bold;
  border-radius: 12px;
  cursor: pointer;
  position: absolute;
  bottom: -64px;
  right: 20px;
}
#cursoBox {
  position: absolute;
  top: 60px;
  left: 100%;
  width: 40px;
  height: 122px;
  background: #4CAF50;
  color: #fff;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}
#cursoText {
  transform: rotate(-90deg);
  font-size: 18px;
  white-space: nowrap;
}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<script>

// ======================================================
// 1. UTILITÁRIOS
// ======================================================
const q = (s,d=document) => d.querySelector(s);
const normCPF = c => c ? c.replace(/\D/g,"").padStart(11,"0") : "";
const fetchJSON = u => fetch(u+"?v="+Date.now()).then(r=>r.json());

// ======================================================
// 2. VARIÁVEIS GLOBAIS
// ======================================================
let sel = null;
let bl = [], rb = [], userBlockedSeats = [], fakeBlockedSeats = [];
let currentUserCPF = "", currentCurso = "", currentBus = "";
const map = {AAL:"0046", ALI:"0046", QUI:"0046"};
const GET = "https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";
const POST = "https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/478aac5453024f5cb3d3b26495d9b7e0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=H6EQYc3xSSZazBjzf0vB_9u5QtwLNj_hnuoBM9CWgz0";
const FAKE_BLOCKING = {enabled:true, courses:["AAL"], ttlMs: (2*60+59)*1000};
const fakeKey = () => `fake:${currentUserCPF}:${currentCurso}:${currentBus}`;

// ======================================================
// 3. BLOQUEIO FAKE
// ======================================================
const applyFakeBlocking = layout => {
  if(!FAKE_BLOCKING.enabled || !FAKE_BLOCKING.courses.includes(currentCurso)) return [];
  const now = Date.now();
  const cached = sessionStorage.getItem(fakeKey());
  if(cached){const d=JSON.parse(cached); if(d.expiresAt>now) return d.seats;}
  const blockedPairs = [];
  layout.forEach(row => {
    for(let i=0;i<row.length-1;i++){
      const a=row[i], b=row[i+1];
      if(typeof a==="number" && typeof b==="number"){
        const sa=a.toString().padStart(2,"0"), sb=b.toString().padStart(2,"0");
        if(!bl.includes(sa) && !bl.includes(sb) && !userBlockedSeats.includes(sa) && !userBlockedSeats.includes(sb)){
          blockedPairs.push([sa,sb]);
        }
      }
    }
  });

  const pairCount = blockedPairs.length;
  let qty = 0;
  if(pairCount>=3 && pairCount<=4) qty=1;
  else if(pairCount>=5 && pairCount<=7) qty=2;
  else if(pairCount>=8 && pairCount<=11) qty=3;
  else if(pairCount>=12 && pairCount<=15) qty=4;
  else if(pairCount>=16) qty=5;

  const chosen = blockedPairs.sort(()=>Math.random()-0.5).slice(0,qty).flat();
  sessionStorage.setItem(fakeKey(), JSON.stringify({seats:chosen, expiresAt: now+FAKE_BLOCKING.ttlMs}));
  return chosen;
};

// ======================================================
// 4. RENDERIZAÇÃO DE POLTRONAS
// ======================================================
const cSeat = (v,rowIndex,lastRowIndex) => {
  const e = document.createElement("div");
  if(rowIndex===lastRowIndex && (v===null||typeof v!=="number")){e.className="seat white"; return e;}
  if(v===null){e.className="empty";}
  else if(typeof v==="number"){e.className="seat"; e.textContent=v.toString().padStart(2,"0");}
  return e;
};

const selSeat = e => {
  if(e.classList.contains("white")) return;
  if(e.classList.contains("selected")){e.classList.remove("selected"); sel=null;}
  else {sel?.classList.remove("selected"); e.classList.add("selected"); sel=e;}
};

const render = layout => {
  const w = q(".bus-container"); w.querySelector(".grid")?.remove();
  const g = document.createElement("div"); g.className="grid";
  const lastRowIndex = layout.length-1;
  layout.forEach((row,rowIndex) => {
    row.forEach(v => {
      const e = cSeat(v,rowIndex,lastRowIndex);
      if(typeof v==="number"){
        const id=v.toString().padStart(2,"0");
        if(bl.includes(id)||userBlockedSeats.includes(id)||fakeBlockedSeats.includes(id)){
          e.classList.add("white"); e.textContent="";
        } else e.onclick=()=>selSeat(e);
      }
      g.appendChild(e);
    });
  });
  w.appendChild(g);
};

// ======================================================
// 5. CARREGAMENTO DE DADOS
// ======================================================
const loadData = async () => {
  const cpf=sessionStorage.getItem("cpf"); if(!cpf){location.href="https://rdrgosnto.github.io/planner"; return;}
  currentUserCPF = normCPF(cpf);

  const r = await fetch(GET,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({cpf:currentUserCPF})});
  const data = await r.json();
  const aluno = data.codigo.find(x=>normCPF(x.CPF2||x.CPF)===currentUserCPF);
  currentCurso = aluno.CODIGO.trim().toUpperCase();
  currentBus = map[currentCurso];
  q("#cursoText").textContent = currentCurso;

  const rows = data.poltronas.filter(x=>x.CURSO.trim().toUpperCase()===currentCurso);
  bl = [...new Set(rows.map(x=>x.ID.toString().padStart(2,"0")))];
  rb = rows.map(x=>normCPF(x.CPF2||x.CPF));
  userBlockedSeats = rows.filter(x=>normCPF(x.CPF2||x.CPF)===currentUserCPF).map(x=>x.ID.toString().padStart(2,"0"));

  const cfg = await fetchJSON(`../configs/${currentBus}.json`);
  fakeBlockedSeats = applyFakeBlocking(cfg.layout);
  render(cfg.layout);
  q("#bus-wrapper").style.display = "block";
};

// ======================================================
// 6. CONFIRMAR RESERVA
// ======================================================
const confirmar = async () => {
  if(!sel){alert("Selecione uma poltrona."); return;}
  if(rb.includes(currentUserCPF)){alert("Usuário já possui reserva."); return;}
  await fetch(POST, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({poltrona: sel.textContent, CURSO: currentCurso, cpf: currentUserCPF})});
  location.reload(true);
};

q("#confirmarBtn").onclick = confirmar;
loadData();

</script>
</body>
</html>
