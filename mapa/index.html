<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<script>
if(location.pathname.endsWith("index.html"))
  location.replace(location.pathname.replace("index.html",""));
</script>
<style>
body{font-family:Arial;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.9);transform-origin:top center;display:none}
.bus-container{padding:20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center;justify-items:center}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer}
.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}
.seat.white{background:#fff!important;border:3px solid #8c96b2!important;color:transparent!important;cursor:default!important;pointer-events:none!important}
.seat.white::after{border-color:#8c96b2!important}
.seat.selected{background:#e74c3c;border-color:#e74c3c}
.empty{background:0 0}
.seat.lost{background:#b0b0b0!important;border-color:#b0b0b0!important;color:transparent!important;pointer-events:none!important}
.seat.lost::before{content:"✖";color:#fff;font-size:28px;font-weight:bold;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:#0001;z-index:9999}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .1s linear}
#confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;position:absolute;bottom:-64px;right:20px}
#cursoBox{position:absolute;top:60px;left:100%;width:40px;height:122px;background:#4CAF50;color:#fff;font-weight:bold;display:flex;align-items:center;justify-content:center;z-index:9999;overflow:hidden;pointer-events:none}
#cursoText{transform:rotate(-90deg);font-size:18px;white-space:nowrap}
</style>
</head>
<body>
<div id="bus-wrapper"><div class="bus-container"><div id="cursoBox"><div id="cursoText"></div></div><button id="confirmarBtn">CONFIRMAR</button></div></div>
<div id="progress-bar-container"><div id="progress-bar"></div></div>
<script>
(()=>{const s=Date.now();if(!sessionStorage.getItem("cacheStamp"))sessionStorage.setItem("cacheStamp",s)})();
const q=(s,d=document)=>d.querySelector(s);
let sel=null,bl=[],rb=[],userBlockedSeats=[],fakeBlockedSeats=[],currentUserCPF=null,currentCurso="",currentBus="";
const GET="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";
const POST="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/478aac5453024f5cb3d3b26495d9b7e0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=H6EQYc3xSSZazBjzf0vB_9u5QtwLNj_hnuoBM9CWgz0";
const map={AAL:"0046",ALI:"0046",QUI:"0046"};
const normCPF=c=>c?c.toString().replace(/\D/g,"").padStart(11,"0"):"";
const fetchJSON=u=>fetch(u+"?v="+Date.now()).then(r=>r.json());
const anim=t=>{let w=parseFloat(q("#progress-bar").style.width)||0;(function s(){if(w<t){w++;q("#progress-bar").style.width=w+"%";requestAnimationFrame(s)}})()};
const cSeat=v=>{const e=document.createElement("div");if(v===null)e.className="empty";else if(v=="white")e.className="seat white";else{e.className="seat";e.textContent=v.toString().padStart(2,"0")}return e};
const selSeat=e=>{if(e.classList.contains("white")||e.classList.contains("lost"))return;if(e.classList.contains("selected"))e.classList.remove("selected"),sel=null;else{if(sel)sel.classList.remove("selected");e.classList.add("selected");sel=e}};
const getField=(o,...n)=>{for(const x of n){const k=Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());if(k)return o[k]}};
const cpfStored=sessionStorage.getItem("cpf");if(!cpfStored){location.href="https://rdrgosnto.github.io/planner";throw""}currentUserCPF=normCPF(cpfStored);

// ================= BLOQUEIO FAKE COM TTL =================
const FAKE_BLOCKING={enabled:true,courses:["AAL"],ttlMs:(2*60+59)*1000}; // 2min 59seg
const fakeKey=()=>`fake:${currentUserCPF}:${currentCurso}:${currentBus}`;
const applyFakeBlocking=(layout)=>{
  if(!FAKE_BLOCKING.enabled || !FAKE_BLOCKING.courses.includes(currentCurso)) return [];
  const now=Date.now();
  const cached=sessionStorage.getItem(fakeKey());
  if(cached){
    const d=JSON.parse(cached);
    if(d.expiresAt>now) return d.seats;
  }
  const pairs=[];
  layout.forEach(row=>{
    for(let i=0;i<row.length-1;i++){
      if(typeof row[i]==="number" && typeof row[i+1]==="number"){
        const a=row[i].toString().padStart(2,"0"), b=row[i+1].toString().padStart(2,"0");
        if(!bl.includes(a)&&!bl.includes(b)&&!userBlockedSeats.includes(a)&&!userBlockedSeats.includes(b))
          pairs.push([a,b]);
      }
    }
  });
  let qty=0;
  if(pairs.length>=3 && pairs.length<=4) qty=1;
  else if(pairs.length>=5 && pairs.length<=7) qty=2;
  else if(pairs.length>=8 && pairs.length<=11) qty=3;
  else if(pairs.length>=12 && pairs.length<=15) qty=4;
  else if(pairs.length>=16) qty=5;
  const chosen=pairs.sort(()=>Math.random()-0.5).slice(0,qty).flat();
  sessionStorage.setItem(fakeKey(),JSON.stringify({seats:chosen,expiresAt:now+FAKE_BLOCKING.ttlMs}));
  return chosen;
};
// =====================================================

const render=l=>{
  const w=q(".bus-container"); w.querySelector(".grid")?.remove();
  const g=document.createElement("div"); g.className="grid";
  l.flat().forEach(v=>{
    const e=cSeat(v);
    if(v!==null && v!=="white"){
      const id=v.toString().padStart(2,"0"); e.dataset.seat=id;
      if(bl.includes(id) || userBlockedSeats.includes(id) || fakeBlockedSeats.includes(id)){
        e.classList.add("white"); e.textContent="";
      } else e.onclick=()=>selSeat(e);
    }
    g.appendChild(e);
  });
  w.appendChild(g);
};

const fetchFlow=async(u,c)=>{try{const r=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf:c})});return{ok:r.ok,status:r.status,json:r.ok?await r.json():null}}catch(e){return{ok:0,status:0,error:e}}};

const load=async()=>{
  anim(20);
  const r=await fetchFlow(GET,currentUserCPF);
  if(!r.ok || !r.json){alert("Erro ao consultar fluxo."); return}
  const lista=r.json.poltronas||r.json.lista||[],cod=r.json.codigo||r.json.cursos||[];
  anim(50);
  const aluno=cod.find(x=>normCPF(getField(x,"CPF2","CPF"))===currentUserCPF);
  if(!aluno){alert("CPF não encontrado.");return}
  currentCurso=getField(aluno,"CODIGO","Codigo","codigo").toString().trim().toUpperCase();
  currentBus=map[currentCurso]||"0046"; q("#cursoText").textContent=currentCurso;
  anim(70);
  const cursoRows=lista.filter(x=>getField(x,"CURSO","Curso","curso")?.toString().trim().toUpperCase()===currentCurso);
  bl=[...new Set(cursoRows.map(x=>getField(x,"ID","Id","id")?.toString().padStart(2,"0")).filter(Boolean))];
  rb=cursoRows.map(x=>normCPF(getField(x,"CPF2","Cpf2","cpf2","CPF","cpf"))).filter(Boolean);
  userBlockedSeats=cursoRows.filter(x=>normCPF(getField(x,"CPF2","Cpf2","cpf2","CPF","cpf"))===currentUserCPF).map(x=>getField(x,"ID","Id","id").toString().padStart(2,"0"));
  const cfg=await fetchJSON(`../configs/${currentBus}.json`); if(!cfg){alert("Erro layout"); return}
  fakeBlockedSeats = applyFakeBlocking(cfg.layout);
  render(cfg.layout);
  const last=sessionStorage.getItem("lastAttempt");
  if(last){
    const lastId=last.toString().padStart(2,"0"),
          ownerRow=cursoRows.find(x=>getField(x,"ID","Id","id").toString().padStart(2,"0")===lastId),
          ownerCpf=ownerRow?normCPF(getField(ownerRow,"CPF2","Cpf2","cpf2","CPF","cpf")):null;
    if(bl.includes(lastId)&&ownerCpf&&ownerCpf!==currentUserCPF){
      const el=[...document.querySelectorAll(".seat")].find(s=>s.dataset.seat===lastId);
      if(el){el.classList.remove("white"); el.classList.add("lost")}
    }
    sessionStorage.removeItem("lastAttempt")
  }
  anim(100); setTimeout(()=>q("#progress-bar-container").remove(),600); q("#bus-wrapper").style.display="block";
};

q("#confirmarBtn").onclick=async()=>{
  if(!sel){alert("Selecione uma poltrona.");return}
  document.querySelectorAll(".seat").forEach(s=>s.style.pointerEvents="none"); q("#confirmarBtn").disabled=true;
  if(rb.includes(currentUserCPF)){alert("Usuário já possui reserva."); setTimeout(()=>{
    sel?.classList.remove("selected"); sel=null;
    document.querySelectorAll(".seat").forEach(s=>s.style.pointerEvents="auto");
    q("#confirmarBtn").disabled=false
  },2000); return}
  sessionStorage.setItem("lastAttempt",sel.dataset.seat||sel.textContent);
  try{
    const r=await fetch(POST,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({poltrona:sel.textContent,CURSO:currentCurso,cpf:currentUserCPF})});
    alert(r.ok?"Poltrona selecionada!":"Poltrona selecionada por outro usuário.");
    setTimeout(()=>location.reload(true),2000)
  }catch{alert("Erro de comunicação."); setTimeout(()=>location.reload(true),2200)}
};

load();
</script>
</body>
</html>
