<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<script>
if(location.pathname.endsWith("index.html")){
  location.replace(location.pathname.replace("index.html",""));
}
</script>

<style>
body{font-family:Arial;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.9);transform-origin:top center;display:none}
.bus-container{padding:20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center;justify-items:center}

.seat,.empty{
  width:54px;height:54px;
  display:flex;align-items:center;justify-content:center;
  border-radius:12px;position:relative
}

.seat{
  background:#4CAF50;
  border:3px solid #4CAF50;
  color:#fff;font-weight:bold;
  cursor:pointer
}

.seat::after{
  content:"";
  position:absolute;
  bottom:-8px;left:50%;
  transform:translateX(-50%);
  width:32px;height:14px;
  border-radius:8px;
  background:#fff;
  border:3px solid #8c96b2
}

.seat.white{
  background:#fff!important;
  border:3px solid #8c96b2!important;
  color:transparent!important;
  pointer-events:none!important
}

.seat.selected{
  background:#e74c3c;
  border-color:#e74c3c
}

.empty{background:none}

#confirmarBtn{
  width:112px;height:54px;
  background:#4CAF50;color:#fff;
  border:none;font-size:16px;font-weight:bold;
  border-radius:12px;cursor:pointer;
  position:absolute;bottom:-64px;right:20px
}

#cursoBox{
  position:absolute;top:60px;left:100%;
  width:40px;height:122px;
  background:#4CAF50;color:#fff;
  font-weight:bold;
  display:flex;align-items:center;justify-content:center
}

#cursoText{transform:rotate(-90deg);font-size:18px;white-space:nowrap}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<script>
/* =========================
   HELPERS
========================= */
const q=(s,d=document)=>d.querySelector(s);
const normCPF=c=>c?c.replace(/\D/g,"").padStart(11,"0"):"";
const fetchJSON=u=>fetch(u+"?v="+Date.now()).then(r=>r.json());

let sel=null, bl=[], userBlockedSeats=[], fakeBlockedSeats=[];
let currentUserCPF="", currentCurso="", currentBus="";

/* =========================
   FEATURE FLAG
========================= */
const FAKE_BLOCKING_FEATURE={
  enabled:true,
  courses:["AAL"],
  ttlMs:(2*60+59)*1000
};

/* =========================
   API
========================= */
const GET="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";
const map={AAL:"0046",ALI:"0046",QUI:"0046"};

/* =========================
   FAKE BLOCKING (SEM SOBRA)
========================= */
const fakeKey=()=>`fake:${currentUserCPF}:${currentCurso}:${currentBus}`;

const applyFakeBlocking=layout=>{
  if(!FAKE_BLOCKING_FEATURE.enabled) return [];
  if(!FAKE_BLOCKING_FEATURE.courses.includes(currentCurso)) return [];

  const now=Date.now();
  const key=fakeKey();
  const cached=sessionStorage.getItem(key);

  if(cached){
    const d=JSON.parse(cached);
    if(d.expiresAt>now) return d.seats;
    sessionStorage.removeItem(key);
  }

  const rows=layout.map(r=>r.filter(v=>typeof v==="number"));
  const freePairs=[];

  rows.forEach(row=>{
    for(let i=0;i<row.length-1;i++){
      const a=row[i].toString().padStart(2,"0");
      const b=row[i+1].toString().padStart(2,"0");

      if(
        !bl.includes(a) &&
        !bl.includes(b) &&
        !userBlockedSeats.includes(a) &&
        !userBlockedSeats.includes(b)
      ){
        freePairs.push([a,b]);
      }
    }
  });

  if(!freePairs.length) return [];

  const shuffled=[...freePairs].sort(()=>Math.random()-0.5);
  const maxPairs=freePairs.length>6?3:2;

  const chosen=shuffled.slice(0,maxPairs).flat();

  sessionStorage.setItem(key,JSON.stringify({
    seats:chosen,
    expiresAt:now+FAKE_BLOCKING_FEATURE.ttlMs
  }));

  return chosen;
};

/* =========================
   RENDER
========================= */
const cSeat=v=>{
  const e=document.createElement("div");
  if(v===null) e.className="empty";
  else if(v==="white") e.className="seat white";
  else{
    e.className="seat";
    e.textContent=v.toString().padStart(2,"0");
  }
  return e;
};

const render=layout=>{
  const w=q(".bus-container");
  w.querySelector(".grid")?.remove();
  const g=document.createElement("div");
  g.className="grid";

  layout.flat().forEach(v=>{
    const e=cSeat(v);

    if(typeof v==="number"){
      const id=v.toString().padStart(2,"0");

      if(bl.includes(id)||userBlockedSeats.includes(id)||fakeBlockedSeats.includes(id)){
        e.classList.add("white");
        e.textContent="";
      }else{
        e.onclick=()=>{
          if(e.classList.contains("selected")){
            e.classList.remove("selected");
            sel=null;
          }else{
            sel?.classList.remove("selected");
            sel=e;
            e.classList.add("selected");
          }
        };
      }
    }
    g.appendChild(e);
  });
  w.appendChild(g);
};

/* =========================
   LOAD
========================= */
(async()=>{
  const cpfStored=sessionStorage.getItem("cpf");
  if(!cpfStored){
    location.href="https://rdrgosnto.github.io/planner";
    return;
  }
  currentUserCPF=normCPF(cpfStored);

  const r=await fetch(GET,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({cpf:currentUserCPF})
  });
  const data=await r.json();

  const aluno=data.codigo.find(x=>normCPF(x.CPF2||x.CPF)===currentUserCPF);
  currentCurso=aluno.CODIGO.trim().toUpperCase();
  currentBus=map[currentCurso]||"0046";
  q("#cursoText").textContent=currentCurso;

  const rows=data.poltronas.filter(x=>x.CURSO.trim().toUpperCase()===currentCurso);
  bl=[...new Set(rows.map(x=>x.ID.toString().padStart(2,"0")))];
  userBlockedSeats=rows
    .filter(x=>normCPF(x.CPF2||x.CPF)===currentUserCPF)
    .map(x=>x.ID.toString().padStart(2,"0"));

  const cfg=await fetchJSON(`../configs/${currentBus}.json`);
  fakeBlockedSeats=applyFakeBlocking(cfg.layout);
  render(cfg.layout);

  q("#bus-wrapper").style.display="block";
})();
</script>

</body>
</html>
