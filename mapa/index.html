<!DOCTYPE html><html lang="pt-BR"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>
<meta http-equiv="Cache-Control" content="no-cache,no-store,must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
body{font-family:Arial;margin:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.8);transform-origin:top center;display:none}
.bus-container{padding:20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer}
.seat.selected,.seat.mine{background:#e74c3c;border-color:#e74c3c;cursor:default}
.seat.white,.seat.lost,.seat.lost-temp{color:transparent!important;pointer-events:none!important}
.seat.white{background:#fff!important;border:3px solid #8c96b2!important}
.seat.lost-temp{background:#aaa!important;border-color:#777!important}
.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}
.seat.lost::before{content:"✖";color:#fff;font-size:28px;font-weight:bold;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
.empty{background:none}
#confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;position:absolute;bottom:-64px;right:20px}
#confirmarBtn.trocar{background:#4CAF50}
#cursoBox{position:absolute;top:60px;left:100%;width:40px;height:122px;background:#4CAF50;color:#fff;font-weight:bold;display:flex;align-items:center;justify-content:center;z-index:9;pointer-events:none}
#cursoText{transform:rotate(-90deg);font-size:18px;white-space:nowrap}
#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:#0001}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .1s linear}
</style>
</head><body>

<div id="bus-wrapper"><div class="bus-container">
<div id="cursoBox"><div id="cursoText"></div></div>
<button id="confirmarBtn">CONFIRMAR</button>
</div></div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
const q=s=>document.querySelector(s),
norm=c=>c?.replace(/\D/g,"").padStart(11,"0")||"",
gf=(o,...n)=>n.map(k=>Object.keys(o||{}).find(x=>x.toLowerCase()==k.toLowerCase())).find(Boolean)&&o[Object.keys(o).find(x=>x.toLowerCase()==n.find(k=>x.toLowerCase()==k.toLowerCase()))];

let sel=null,bl=[],userSeats=[],cpf="",curso="",layout=[],lock=0;

const GET="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA",
POST="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/478aac5453024f5cb3d3b26495d9b7e0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=H6EQYc3xSSZazBjzf0vB_9u5QtwLNj_hnuoBM9CWgz0",
TROCAR="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1d167b2351e14940acb006f964b87cef/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=V8asrBbmlcMNS9h0ubUJ8Sd8wT02Knni3VOhhU0IjFg",
map={AAL:"0046",ALI:"0046",QUI:"0046"};

const anim=t=>{let w=0;const b=q("#progress-bar");(function a(){w<t&&(b.style.width=++w+"%",requestAnimationFrame(a))})()};

const seat=v=>{const e=document.createElement("div");e.className=v==null?"empty":v=="white"?"seat white":"seat";if(v&&v!="white"){e.dataset.seat=v.padStart(2,"0");e.textContent=e.dataset.seat}return e};

const render=l=>{const c=q(".bus-container");c.querySelector(".grid")?.remove();const g=document.createElement("div");g.className="grid";
l.flat().forEach(v=>{const e=seat(v);if(v&&v!="white"){const id=e.dataset.seat;
userSeats.includes(id)?e.classList.add("mine"):
bl.includes(id)?e.classList.add("white"):
e.onclick=()=>{if(lock||e.classList.contains("mine"))return;sel?.classList.remove("selected");sel=sel==e?null:e;e.classList.toggle("selected",sel==e)}}
g.appendChild(e)});c.appendChild(g)};

const btnState=()=>q("#confirmarBtn").classList.toggle("trocar",userSeats.length>0);

async function load(){
cpf=norm(sessionStorage.getItem("cpf"));
if(!cpf)return location.href="https://rdrgosnto.github.io/planner";
anim(20);
const r=await fetch(GET,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf})}).then(r=>r.ok?r.json():0);
if(!r)return alert("Erro ao consultar fluxo");
anim(50);
const aluno=(r.codigo||[]).find(x=>norm(gf(x,"CPF","CPF2"))==cpf);
if(!aluno)return alert("CPF não encontrado");
curso=gf(aluno,"CODIGO","codigo").toUpperCase();
q("#cursoText").textContent=curso;
const rows=(r.poltronas||[]).filter(x=>gf(x,"CURSO","curso").toUpperCase()==curso);
bl=[...new Set(rows.map(x=>gf(x,"ID","id")?.padStart(2,"0")).filter(Boolean))];
userSeats=rows.filter(x=>norm(gf(x,"CPF","CPF2"))==cpf).map(x=>gf(x,"ID","id").padStart(2,"0"));
layout=(await fetch(`../configs/${map[curso]||"0046"}.json`).then(r=>r.json())).layout;
render(layout);btnState();anim(100);
setTimeout(()=>q("#progress-bar-container").remove(),600);
q("#bus-wrapper").style.display="block";
location.pathname.endsWith("index.html")&&history.replaceState(null,"",location.pathname.replace("index.html",""));
}

q("#confirmarBtn").onclick=async()=>{
if(lock||!sel)return alert("Selecione uma poltrona");
lock=1;q("#confirmarBtn").disabled=1;
const nova=sel.dataset.seat,ant=userSeats[0]||null;
const body=ant?{cpf,curso,current:ant,select:nova}:{poltrona:nova,CURSO:curso,cpf};
const url=ant?TROCAR:POST;
const ok=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)}).then(r=>r.ok).catch(()=>0);
if(ok){
ant&&document.querySelector(".seat.mine")?.classList.remove("mine");
userSeats=[nova];sel.classList.add("mine");sel.classList.remove("selected");btnState();
alert(ant?"Poltrona trocada com sucesso!":"Poltrona selecionada!");
}else{
sel.classList.remove("selected");sel.classList.add("lost-temp");
setTimeout(()=>{sel.classList.remove("lost-temp");sel.classList.add("white")},1e4);
alert("Poltrona selecionada por outro usuário.");
}
sel=null;setTimeout(()=>{q("#confirmarBtn").disabled=0;lock=0},4e3);
};

load();
</script>
</body></html>
