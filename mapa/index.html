<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<script>
if (location.pathname.endsWith("index.html")) {
  location.replace(location.pathname.replace("index.html",""));
}
</script>

<style>
body{font-family:Arial;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.9);transform-origin:top center;display:none}
.bus-container{padding:20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<script>
const q = (s,d=document)=>d.querySelector(s);
const normCPF = c => c ? c.toString().replace(/\D/g,"").padStart(11,"0") : "";

// ðŸ”’ bloqueio acesso direto
const cpfStored = sessionStorage.getItem("cpf");
if(!cpfStored){
  location.replace("https://rdrgosnto.github.io/planner");
  throw "";
}

const currentUserCPF = normCPF(cpfStored);

const GET = "https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";

const fetchFlow = async (url, cpf) => {
  try {
    const r = await fetch(url,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({cpf})
    });
    return r.ok ? await r.json() : null;
  } catch {
    return null;
  }
};

// helper robusto
const getField = (o,...n)=>{
  for(const x of n){
    const k = Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());
    if(k) return o[k];
  }
};

const load = async () => {

  const data = await fetchFlow(GET,currentUserCPF);
  if(!data){
    alert("Erro ao consultar fluxo.");
    return;
  }

  const cod = data.codigo || data.cursos || [];

  // ðŸ”Ž encontra CPF independente do ID
  const aluno = cod.find(x =>
    normCPF(getField(x,"CPF","CPF2")) === currentUserCPF
  );

  if(!aluno){
    alert("CPF nÃ£o encontrado.");
    location.replace("https://rdrgosnto.github.io/planner/index.html");
    return;
  }

  // ðŸ§  leitura correta do ID
  const id = (getField(aluno,"ID","Id","id") ?? "").toString().trim();

  // ðŸ”’ regra principal
  if(id !== "#"){
    alert("CPF nÃ£o autorizado");
    location.replace("https://rdrgosnto.github.io/planner/index.html");
    return;
  }

  // âœ” autorizado
  q("#bus-wrapper").style.display = "block";
};

load();
</script>
</body>
</html>
