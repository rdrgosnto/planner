<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
body{
  font-family:Arial;
  margin:0;
  padding:0;
  display:flex;
  flex-direction:column;
  min-height:100vh;
  justify-content:center;
  background:#fff
}

#bus-wrapper{
  transform:scale(.8);
  transform-origin:top center;
  display:none
}

.bus-container{
  padding:20px;
  border:3px solid #b0b0b0;
  border-radius:16px;
  width:fit-content;
  margin:20px auto;
  position:relative;
  display:flex;
  justify-content:center
}

.grid{
  display:grid;
  grid-template-columns:repeat(5,54px);
  gap:14px 10px;
  justify-content:center;
  justify-items:center
}

.seat,.empty{
  width:54px;
  height:54px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  position:relative
}

.seat{
  background:#4CAF50;
  border:3px solid #4CAF50;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
  user-select:none
}

.seat.selected,
.seat.mine{
  background:#e74c3c;
  border-color:#e74c3c;
  cursor:default
}

/* Bloqueadas */
.seat.white,
.seat.lost,
.seat.lost-temp{
  color:transparent!important;
  cursor:default!important;
  pointer-events:none!important
}

.seat.white{
  background:#fff!important;
  border:3px solid #8c96b2!important
}

.seat.lost-temp{
  background:#aaa!important;
  border-color:#777!important
}

.seat::after{
  content:"";
  position:absolute;
  bottom:-8px;
  left:50%;
  transform:translateX(-50%);
  width:32px;
  height:14px;
  border-radius:8px;
  background:#fff;
  border:3px solid #8c96b2
}

.seat.lost::before{
  content:"✖";
  color:#fff;
  font-size:28px;
  font-weight:bold;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%)
}

/* Botão principal */
#confirmarBtn{
  width:112px;
  height:54px;
  background:#4CAF50;
  color:#fff;
  border:none;
  font-size:16px;
  font-weight:bold;
  border-radius:12px;
  cursor:pointer;
  position:absolute;
  bottom:-64px;
  right:20px;
  user-select:none
}

/* Estado TROCAR */
#confirmarBtn.trocar{
  background:#f1c40f;
  color:#000
}

#cursoBox{
  position:absolute;
  top:60px;
  left:100%;
  width:40px;
  height:122px;
  background:#4CAF50;
  color:#fff;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  overflow:hidden;
  pointer-events:none
}

#cursoText{
  transform:rotate(-90deg);
  font-size:18px;
  white-space:nowrap
}

#progress-bar-container{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  height:8px;
  background:#0001;
  z-index:9999
}

#progress-bar{
  width:0;
  height:100%;
  background:#4CAF50;
  transition:width .1s linear
}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<div id="progress-bar-container">
  <div id="progress-bar"></div>
</div>

<script>
/* ======================
   UTILITÁRIOS
====================== */
const q = s => document.querySelector(s);
const norm = c => c?.toString().replace(/\D/g,"").padStart(11,"0") || "";
const gf = (o,...n)=>{
  for(const x of n){
    const k = Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());
    if(k) return o[k];
  }
};

/* ======================
   ESTADO GLOBAL
====================== */
let sel=null, bl=[], userSeats=[], currentCPF=null, currentCurso="", layout=[], isLocked=false;

/* ======================
   FLOWS POWER AUTOMATE
====================== */
const GET="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";

const POST="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/478aac5453024f5cb3d3b26495d9b7e0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=H6EQYc3xSSZazBjzf0vB_9u5QtwLNj_hnuoBM9CWgz0";

/* Fluxo de TROCA */
const POST_TROCAR="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1d167b2351e14940acb006f964b87cef/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=V8asrBbmlcMNS9h0ubUJ8Sd8wT02Knni3VOhhU0IjFg";

/* ======================
   BOTÃO: CONFIRMAR ⇄ TROCAR
====================== */
const updateButtonState = ()=>{
  const btn=q("#confirmarBtn");
  if(userSeats.length>0){
    btn.textContent="TROCAR";
    btn.classList.add("trocar");
  }else{
    btn.textContent="CONFIRMAR";
    btn.classList.remove("trocar");
  }
};

/* ======================
   CLICK DO BOTÃO
====================== */
q("#confirmarBtn").onclick=async()=>{
  if(isLocked) return;
  if(!sel){ alert("Selecione uma poltrona."); return; }

  isLocked=true;
  document.querySelectorAll(".seat").forEach(s=>s.style.pointerEvents="none");
  q("#confirmarBtn").disabled=true;

  const nova=sel.dataset.seat;
  const antiga=userSeats[0]||null;

  try{
    const url=antiga?POST_TROCAR:POST;
    const payload=antiga
      ?{cpf:currentCPF,curso:currentCurso,current:antiga,select:nova}
      :{cpf:currentCPF,CURSO:currentCurso,poltrona:nova};

    const r=await fetch(url,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });

    if(r.ok){
      if(antiga){
        document.querySelector(".seat.mine")?.classList.remove("mine");
        userSeats=[];
      }
      sel.classList.add("mine");
      sel.classList.remove("selected");
      userSeats.push(nova);
      updateButtonState();
      alert(antiga?"Poltrona trocada com sucesso!":"Poltrona selecionada!");
    }else{
      alert("Poltrona selecionada por outro usuário.");
      sel.classList.remove("selected");
      sel.classList.add("lost-temp");
      const s=sel;
      setTimeout(()=>{
        s.classList.remove("lost-temp");
        s.classList.add("white");
      },10000);
    }
  }catch{
    alert("Erro de comunicação.");
  }

  sel=null;
  setTimeout(()=>{
    document.querySelectorAll(".seat").forEach(s=>{
      if(!s.classList.contains("mine")) s.style.pointerEvents="auto";
    });
    q("#confirmarBtn").disabled=false;
    isLocked=false;
  },4000);
};

/* ======================
   LOAD INICIAL
====================== */
const load=async()=>{
  const cpf=sessionStorage.getItem("cpf");
  if(!cpf){ location.href="https://rdrgosnto.github.io/planner"; return; }

  currentCPF=norm(cpf);
  const r=await fetch(GET,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf:currentCPF})});
  const j=await r.json();

  const aluno=j.cursos.find(x=>norm(x.CPF2)===currentCPF);
  currentCurso=aluno.CODIGO;
  q("#cursoText").textContent=currentCurso;

  const rows=j.poltronas.filter(x=>x.CURSO===currentCurso);
  userSeats=rows.filter(x=>norm(x.CPF2)===currentCPF).map(x=>x.ID.padStart(2,"0"));
  bl=rows.map(x=>x.ID.padStart(2,"0"));

  const cfg=await fetch("../configs/0046.json").then(r=>r.json());
  layout=cfg.layout;

  render(layout);
  updateButtonState();
  q("#bus-wrapper").style.display="block";
};

load();
</script>
</body>
</html>
