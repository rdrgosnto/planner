<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<style>
body{font-family:Arial;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.8);transform-origin:top center;display:none}
.bus-container{padding:20px 20px 24px 20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center;justify-items:center}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer;user-select:none}
.seat.selected,.seat.mine{background:#e74c3c;border-color:#e74c3c;cursor:default}
.seat.white,.seat.lost,.seat.lost-temp{color:transparent!important;cursor:default!important;pointer-events:none!important}
.seat.white{background:#fff!important;border:3px solid #8c96b2!important}
.seat.lost-temp{background:#aaa!important;border-color:#777!important}
.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}
.seat.lost::before{content:"✖";color:#fff;font-size:28px;font-weight:bold;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
.empty{background:0 0}
#confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;position:absolute;bottom:-64px;right:20px;user-select:none}
#confirmarBtn.trocar{background:#4CAF50;color:#fff}
#cursoBox{position:absolute;top:60px;left:100%;width:40px;height:122px;background:#4CAF50;color:#fff;font-weight:bold;display:flex;align-items:center;justify-content:center;z-index:9999;overflow:hidden;pointer-events:none}
#cursoText{transform:rotate(-90deg);font-size:18px;white-space:nowrap}
#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:#0001;z-index:9999}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .1s linear}

/* Card branco centralizado */
#seatCard {
  position: fixed;
  width: calc(54px * 4 + 10px * 3);
  height: calc(54px * 5 + 14px * 4);
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,.25);
  padding: 14px;
  z-index: 10000;
  display: none;
  font-family: Arial;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

#seatCard .seat-info { display: flex; gap: 12px; margin-bottom: 16px; }
#seatCard .seat-number {
  width: 54px; height: 54px; border-radius: 12px;
  background: #4CAF50; color: #fff; font-weight: bold;
  display: flex; align-items: center; justify-content: center; font-size: 20px;
}
#seatCard .seat-text { font-size: 14px; }
#seatCard .seat-text b { display: block; font-size: 15px; }
#seatCard .question { margin: 18px 0 12px; font-weight: bold; }
#seatCard .actions { display: flex; gap: 12px; justify-content: flex-end; }
#seatCard button { width: 90px; height: 40px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
#seatCard .yes { background: #4CAF50; color: #fff; }
#seatCard .no { background: #ccc; }
</style>
</head>
<body>
<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<div id="seatCard">
  <div class="seat-info">
    <div class="seat-number" id="cardSeatNum"></div>
    <div class="seat-text">
      <b id="cardName"></b>
      <span id="cardCPF"></span>
    </div>
  </div>
  <div class="question">Deseja alterar a poltrona?</div>
  <div class="actions">
    <button class="yes">SIM</button>
    <button class="no">NÃO</button>
  </div>
</div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
const q=s=>document.querySelector(s),
norm=c=>c?.toString().replace(/\D/g,"").padStart(11,"0")||"",
gf=(o,...n)=>{for(const x of n){const k=Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());if(k)return o[k]}};
let sel=null, bl=[], userSeats=[], currentCPF=null, currentCurso="", layout=[], isLocked=false, blData=[];
const GET="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA",
POST="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/478aac5453024f5cb3d3b26495d9b7e0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=H6EQYc3xSSZazBjzf0vB_9u5QtwLNj_hnuoBM9CWgz0",
POST_TROCAR="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1d167b2351e14940acb006f964b87cef/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=V8asrBbmlcMNS9h0ubUJ8Sd8wT02Knni3VOhhU0IjFg",
map={AAL:"0046",ALI:"0046",QUI:"0046"};

const anim=t=>{let w=parseFloat(q("#progress-bar").style.width)||0;(function s(){w<t?(w++,q("#progress-bar").style.width=w+"%",requestAnimationFrame(s)):0})()};
const fetchFlow=async(u,c)=>{try{const r=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf:c})});return{ok:r.ok,json:r.ok?await r.json():null}}catch{return{ok:0}}};
const cSeat=v=>{const e=document.createElement("div");e.className=v===null?"empty":v==="white"?"seat white":"seat";if(v && v!=="white"){e.dataset.seat=v.toString().padStart(2,"0"); e.textContent=e.dataset.seat}if(v==="white") e.dataset.white="true";return e};
const selSeat=e=>{if(isLocked) return;if(!e.classList.contains("white") && !e.classList.contains("lost") && !e.classList.contains("mine") && !e.classList.contains("lost-temp")){sel?.classList.remove("selected");sel = sel===e?null:e;e.classList.toggle("selected", sel===e)}};
const render=l=>{
  const w=q(".bus-container");w.querySelector(".grid")?.remove();
  const g=document.createElement("div");g.className="grid";
  l.forEach(row=>row.forEach(v=>{
    const e=cSeat(v);
    if(v && v!=="white"){
      const id=e.dataset.seat;
      
      // clique longo
      e.onmousedown = () => { pressTimer = setTimeout(() => { showSeatCard(e,id); },600); };
      e.onmouseup = e.onmouseleave = () => { clearTimeout(pressTimer); };
      
      if(userSeats.includes(id)) e.classList.add("mine");
      else if(bl.includes(id)) e.classList.add("white");
      else e.onclick=()=>selSeat(e);
    }
    g.appendChild(e);
  }));
  w.appendChild(g);
};

const updateButtonState=()=>{const btn=q("#confirmarBtn");if(userSeats.length>0){btn.textContent="CONFIRMAR";btn.classList.add("trocar")} else {btn.textContent="CONFIRMAR";btn.classList.remove("trocar")}};
const load=async()=>{
  const cpf=sessionStorage.getItem("cpf");if(!cpf){location.href="https://rdrgosnto.github.io/planner";return}
  currentCPF=norm(cpf);anim(20);
  const r=await fetchFlow(GET,currentCPF);if(!r.ok||!r.json){alert("Erro ao consultar fluxo.");return}anim(50);
  const lista=r.json.poltronas || r.json.lista || [], cod=r.json.codigo||r.json.cursos||[];
  blData = lista; // tabela usada pelo Card
  const aluno=cod.find(x=>norm(gf(x,"CPF2","CPF"))===currentCPF);if(!aluno){alert("CPF não encontrado.");return}
  currentCurso=gf(aluno,"CODIGO","Codigo","codigo").toString().trim().toUpperCase();q("#cursoText").textContent=currentCurso;
  const rows=lista.filter(x=>gf(x,"CURSO","Curso","curso")?.toString().trim().toUpperCase()===currentCurso);
  bl=[...new Set(rows.map(x=>gf(x,"ID","Id","id")?.toString().padStart(2,"0")).filter(Boolean))];
  userSeats=rows.filter(x=>norm(gf(x,"CPF2","CPF"))===currentCPF).map(x=>gf(x,"ID","Id","id").toString().padStart(2,"0"));
  const cfg=await fetch(`../configs/${map[currentCurso]||"0046"}.json`).then(r=>r.json());layout=cfg.layout;
  render(layout);updateButtonState();anim(100);setTimeout(()=>q("#progress-bar-container").remove(),600);
  q("#bus-wrapper").style.display="block";
};

q("#confirmarBtn").onclick = async () => {
  if(isLocked) return;
  if(!sel){ alert("Selecione uma poltrona."); return }

  const ok = confirm("Confirma a poltrona selecionada?");
  if(!ok){ sel.classList.remove("selected"); sel.style.pointerEvents = "auto"; return; }

  isLocked = true;
  document.querySelectorAll(".seat").forEach(s => s.style.pointerEvents = "none");
  q("#confirmarBtn").disabled = true;
  const nova = sel.dataset.seat;
  const antiga = userSeats[0] || null;
  try {
    const url = antiga ? POST_TROCAR : POST;
    const payload = antiga ? { cpf: currentCPF, curso: currentCurso, current: antiga, select: nova } : { poltrona: nova, CURSO: currentCurso, cpf: currentCPF };
    const r = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
    if(r.ok){
      userSeats = [nova];
      if(antiga) {
        bl = bl.filter(x => x !== antiga);
        const antigaElem = document.querySelector(`.seat[data-seat="${antiga}"]`);
        if(antigaElem) delete antigaElem.dataset.white;
      }
      document.querySelectorAll(".seat").forEach(s => {
        const id = s.dataset.seat;
        if(id === nova){
          s.classList.add("mine"); s.classList.remove("white","lost-temp","selected"); s.style.pointerEvents = "none"; s.onclick = null;
        } else if(id === antiga){
          s.classList.remove("mine","lost-temp","selected"); s.classList.add("seat"); s.style.pointerEvents = "auto"; s.onclick = () => selSeat(s);
        } else if(bl.includes(id) || s.dataset.white === "true"){
          s.classList.add("white"); s.classList.remove("mine","lost-temp","selected"); s.style.pointerEvents = "none"; s.onclick = null;
        }
      });
      updateButtonState();
      alert(antiga ? "Poltrona trocada com sucesso!" : "Poltrona selecionada!");
    } else {
      alert("Poltrona selecionada por outro usuário.");
      sel.classList.remove("selected"); sel.classList.add("lost-temp");
      setTimeout(()=>{sel.classList.remove("lost-temp");sel.classList.add("white");},10000);
    }
  } catch { alert("Erro de comunicação."); }
  sel = null;
  setTimeout(()=>{
    document.querySelectorAll(".seat").forEach(s=>{if(!s.classList.contains("mine") && !s.classList.contains("white")) s.style.pointerEvents = "auto"});
    q("#confirmarBtn").disabled = false;
    isLocked = false;
  },2000);
};

// === Card clique longo centralizado ===
let pressTimer = null;
const card = q("#seatCard");
function showSeatCard(seatElem, seatId) {
  const dados = blData.find(x => gf(x,"ID","Id","id")?.toString().padStart(2,"0") === seatId);
  q("#cardSeatNum").textContent = seatId;
  q("#cardName").textContent = dados ? gf(dados,"NOME","Nome","nome") : "—";
  q("#cardCPF").textContent = dados ? gf(dados,"CPF2","CPF","cpf") : "";
  card.style.display = "block"; // card sempre centralizado pelo CSS
}
card.querySelector(".no").onclick = () => { card.style.display = "none"; };
card.querySelector(".yes").onclick = () => {};

load();
</script>
</body>
</html>
