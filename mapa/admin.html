<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>
<style>
body{font-family:Arial;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.8);transform-origin:top center;display:none}
.bus-container{padding:20px 20px 24px 20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center;justify-items:center}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer;user-select:none}
.seat.selected,.seat.mine{background:#e74c3c;border-color:#e74c3c;cursor:default}
.seat.white,.seat.lost,.seat.lost-temp{color:transparent!important;cursor:default!important;pointer-events:none!important}
.seat.white{background:#fff!important;border:3px solid #8c96b2!important}
.seat.lost-temp{background:#aaa!important;border-color:#777!important}
.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}
.seat.lost::before{content:"✖";color:#fff;font-size:28px;font-weight:bold;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
.empty{background:0 0}
#confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;position:absolute;bottom:-64px;right:20px;user-select:none}
#confirmarBtn.trocar{background:#4CAF50;color:#fff}
#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:#0001;z-index:9999}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .1s linear}

/* Card centralizado com animação */
#seatCard {
  position: fixed;
  width: calc(54px * 4 + 10px * 3);
  height: calc(54px * 5 + 14px * 4);
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,.25);
  padding: 14px;
  z-index: 10000;
  display: none;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  opacity: 0;
  transition: all 0.25s ease;
}
#seatCard.show {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}
#seatCard .seat-info { display: flex; gap: 12px; margin-bottom: 16px; }
#seatCard .seat-number { width: 54px; height: 54px; border-radius: 12px; background: #4CAF50; color: #fff; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 20px; }
#seatCard .seat-text { font-size: 14px; }
#seatCard .seat-text b { display: block; font-size: 15px; }
#seatCard .question { margin: 18px 0 12px; font-weight: bold; }
#seatCard .actions { display: flex; gap: 12px; justify-content: flex-end; }
#seatCard button { width: 90px; height: 40px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
#seatCard .yes { background: #4CAF50; color: #fff; }
#seatCard .no { background: #ccc; }
</style>
</head>
<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<div id="seatCard">
  <div class="seat-info">
    <div class="seat-number" id="cardSeatNum"></div>
    <div class="seat-text">
      <b id="cardName"></b>
      <span id="cardCPF"></span>
    </div>
  </div>
  <div class="question">Deseja alterar a poltrona?</div>
  <div class="actions">
    <button class="yes">SIM</button>
    <button class="no">NÃO</button>
  </div>
</div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
const q=s=>document.querySelector(s),
norm=c=>c?.toString().replace(/\D/g,"").padStart(11,"0")||"",
gf=(o,...n)=>{for(const x of n){const k=Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());if(k)return o[k]}};

let userSeats=[], layout=[], isLocked=false, blData=[], pressTimer=null;
const card = q("#seatCard");

// Funções do Card
function showSeatCard(seatId){
  const dados = blData.find(x => gf(x,"ID","Id","id")?.toString().padStart(2,"0") === seatId);
  q("#cardSeatNum").textContent = seatId;
  q("#cardName").textContent = dados ? gf(dados,"NOME","Nome","nome") : "—";
  q("#cardCPF").textContent = dados ? gf(dados,"CPF2","CPF","cpf") : "";
  card.style.display="block";
  setTimeout(()=>card.classList.add("show"),10);
}
function hideSeatCard(){
  card.classList.remove("show");
  setTimeout(()=>card.style.display="none",250);
}
card.querySelector(".no").onclick = hideSeatCard;
card.querySelector(".yes").onclick = () => {};
document.addEventListener("click", e => {
  if(card.classList.contains("show") && !card.contains(e.target) && !e.target.classList.contains("seat")){
    hideSeatCard();
  }
});

// Função de renderização
function render(layout){
  const container = q(".bus-container");
  const g = document.createElement("div"); g.className="grid";
  layout.forEach(row=>row.forEach(v=>{
    const e = document.createElement("div");
    e.className="seat";
    e.dataset.seat = v.toString().padStart(2,"0");
    e.textContent = e.dataset.seat;

    e.addEventListener("mousedown", ()=>{ pressTimer=setTimeout(()=>showSeatCard(e.dataset.seat),600); });
    e.addEventListener("mouseup", ()=>clearTimeout(pressTimer));
    e.addEventListener("mouseleave", ()=>clearTimeout(pressTimer));

    g.appendChild(e);
  }));
  container.appendChild(g);
}

// Simulação inicial caso API falhe
const layoutExemplo = [
  [1,2,3,4,5],
  [6,7,8,9,10],
  [11,12,13,14,15],
  [16,17,18,19,20],
  [21,22,23,24,25]
];
blData = layoutExemplo.map(n => ({ID:n.toString().padStart(2,"0"),NOME:"Aluno "+n,CPF2:"000.000.000-"+n}));
render(layoutExemplo);
q("#bus-wrapper").style.display="block";

// === Integração com API real ===
const GET="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";

async function loadAPI(){
  try{
    const cpf = sessionStorage.getItem("cpf") || "";
    const r = await fetch(GET,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf:cpf})});
    if(!r.ok) return;
    const data = await r.json();
    if(!data?.lista) return;
    blData = data.lista.map(x=>({
      ID: gf(x,"ID","Id","id").toString().padStart(2,"0"),
      NOME: gf(x,"NOME","Nome","nome"),
      CPF2: gf(x,"CPF2","CPF","cpf")
    }));
    const polts = blData.map(x=>parseInt(x.ID));
    layout = [polts.slice(0,5), polts.slice(5,10), polts.slice(10,15), polts.slice(15,20), polts.slice(20,25)];
    q(".grid")?.remove();
    render(layout);
  }catch(e){console.error("API falhou", e);}
}

loadAPI();
</script>
</body>
</html>
