<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Planner | Mapa</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <style>
        body{font-family:Arial;margin:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
        #bus-wrapper{transform:scale(.8);transform-origin:top center;display:none}
        .bus-container{padding:20px 20px 24px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
        .grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center}
        .seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
        .seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer;user-select:none}
        .seat.selected,.seat.mine{background:#e74c3c;border-color:#e74c3c;cursor:default}
        .seat.white,.seat.lost-temp{color:transparent!important;cursor:default!important;pointer-events:none!important}
        .seat.white{background:#fff!important;border:3px solid #8c96b2!important}
        .seat.lost-temp{background:#aaa!important;border-color:#777!important}
        .seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}
        .empty{background:0 0}
        #confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;position:absolute;bottom:-64px;right:20px}
        #confirmarBtn:disabled{opacity:0.6;cursor:not-allowed}
        #cursoBox{position:absolute;top:60px;left:100%;width:40px;height:122px;background:#4CAF50;color:#fff;font-weight:bold;display:flex;align-items:center;justify-content:center;pointer-events:none}
        #cursoText{transform:rotate(-90deg);font-size:18px;white-space:nowrap}
        #p-bar-c{position:fixed;bottom:0;width:100%;height:8px;background:#0001}
        #p-bar{width:0;height:100%;background:#4CAF50;transition:width .1s}
    </style>
</head>
<body>
    <div id="bus-wrapper">
        <div class="bus-container">
            <div id="cursoBox"><div id="cursoText"></div></div>
            <button id="confirmarBtn">CONFIRMAR</button>
        </div>
    </div>
    <div id="p-bar-c"><div id="p-bar"></div></div>

<script>
const q=s=>document.querySelector(s),
norm=c=>c?.toString().replace(/\D/g,"").padStart(11,"0")||"",
gf=(o,...n)=>{for(const x of n){const k=Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());if(k)return o[k]}};

let sel=null, bl=[], userSeats=[], currentCPF=null, currentCurso="", isLocked=false;

const BASE_URL = "https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/";
const END = "/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=";
const URLS = {
    GET: `${BASE_URL}239ef024d32946f99a66585bed86d236${END}ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA`,
    POST: `${BASE_URL}478aac5453024f5cb3d3b26495d9b7e0${END}H6EQYc3xSSZazBjzf0vB_9u5QtwLNj_hnuoBM9CWgz0`,
    SWAP: `${BASE_URL}1d167b2351e14940acb006f964b87cef${END}V8asrBbmlcMNS9h0ubUJ8Sd8wT02Knni3VOhhU0IjFg`
};

const anim=t=>{
    let bar=q("#p-bar"), w=0;
    const i=setInterval(()=>{if(w>=t)clearInterval(i);else{w++;bar.style.width=w+"%"}},10);
};

const selSeat=e=>{
    if(isLocked || e.classList.contains("white") || e.classList.contains("mine")) return;
    if(sel) sel.classList.remove("selected");
    sel = (sel===e) ? null : e;
    if(sel) sel.classList.add("selected");
};

const render=l=>{
    const cnt=q(".bus-container"), old=q(".grid");
    if(old) old.remove();
    const g=document.createElement("div"); g.className="grid";
    l.forEach(row=>row.forEach(v=>{
        const e=document.createElement("div");
        if(v===null) e.className="empty";
        else {
            e.className="seat";
            const id=v.toString().padStart(2,"0");
            if(v!=="white") { e.textContent=id; e.dataset.seat=id; }
            if(userSeats.includes(id)) e.classList.add("mine");
            else if(bl.includes(id) || v==="white") e.classList.add("white");
            else e.onclick=()=>selSeat(e);
        }
        g.appendChild(e);
    }));
    cnt.appendChild(g);
};

const load=async()=>{
    const cpf=sessionStorage.getItem("cpf");
    if(!cpf){ location.href="https://rdrgosnto.github.io/planner"; return; }
    currentCPF=norm(cpf); anim(40);

    try {
        const r=await fetch(URLS.GET,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf:currentCPF})});
        const data=await r.json(); anim(70);
        
        const lista=data.poltronas||data.lista||[], cods=data.codigo||data.cursos||[];
        const aluno=cods.find(x=>norm(gf(x,"CPF2","CPF"))===currentCPF);
        if(!aluno) return alert("CPF não encontrado.");

        currentCurso=gf(aluno,"CODIGO","Codigo").toString().trim().toUpperCase();
        q("#cursoText").textContent=currentCurso;

        const rows=lista.filter(x=>gf(x,"CURSO","Curso")?.toString().trim().toUpperCase()===currentCurso);
        bl=[...new Set(rows.map(x=>gf(x,"ID","Id")?.toString().padStart(2,"0")).filter(Boolean))];
        userSeats=rows.filter(x=>norm(gf(x,"CPF2","CPF"))===currentCPF).map(x=>gf(x,"ID","Id").toString().padStart(2,"0"));

        const cfg=await fetch(`../configs/${(currentCurso==="AAL"||currentCurso==="ALI"||currentCurso==="QUI")?"0046":"0046"}.json`).then(r=>r.json());
        render(cfg.layout); anim(100);
        setTimeout(()=>q("#p-bar-c").remove(),600);
        q("#bus-wrapper").style.display="block";
    } catch(e){ alert("Erro ao carregar dados."); }
};

q("#confirmarBtn").onclick=async()=>{
    if(isLocked || !sel) return !sel && alert("Selecione uma poltrona.");
    if(!confirm("Confirma a poltrona selecionada?")) return;

    isLocked=true; q("#confirmarBtn").disabled=true;
    const nova=sel.dataset.seat, antiga=userSeats[0]||null;

    try {
        const payload=antiga?{cpf:currentCPF,curso:currentCurso,current:antiga,select:nova}:{poltrona:nova,CURSO:currentCurso,cpf:currentCPF};
        const r=await fetch(antiga?URLS.SWAP:URLS.POST,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        
        if(r.ok){
            alert(antiga?"Trocada com sucesso!":"Poltrona selecionada!");
            location.reload();
        } else {
            alert("Erro: Poltrona ocupada.");
            sel.classList.add("lost-temp");
            setTimeout(()=>location.reload(),2000);
        }
    } catch(e){ alert("Erro de comunicação."); isLocked=false; q("#confirmarBtn").disabled=false; }
};

load();
</script>
</body>
</html>
