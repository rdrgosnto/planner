<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa (Admin)</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
body{
  font-family:Arial;
  margin:0;
  padding:0;
  display:flex;
  flex-direction:column;
  min-height:100vh;
  justify-content:center;
  background:#fff
}
#bus-wrapper{
  transform:scale(.8);
  transform-origin:top center;
  display:none
}
.bus-container{
  padding:20px 20px 24px 20px;
  border:3px solid #b0b0b0;
  border-radius:16px;
  width:fit-content;
  margin:20px auto;
  position:relative;
  display:flex;
  justify-content:center
}
.grid{
  display:grid;
  grid-template-columns:repeat(5,54px);
  gap:14px 10px;
  justify-content:center;
  justify-items:center
}
.seat,.empty{
  width:54px;
  height:54px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  position:relative
}
.seat{
  background:#4CAF50;
  border:3px solid #4CAF50;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
  user-select:none
}
.seat.selected,.seat.mine{
  background:#e74c3c;
  border-color:#e74c3c;
  cursor:default
}
.seat.white,.seat.lost,.seat.lost-temp{
  color:transparent!important;
  cursor:default!important;
  pointer-events:none!important
}
.seat.white{
  background:#fff!important;
  border:3px solid #8c96b2!important
}
.seat.lost-temp{
  background:#aaa!important;
  border-color:#777!important
}
.seat::after{
  content:"";
  position:absolute;
  bottom:-8px;
  left:50%;
  transform:translateX(-50%);
  width:32px;
  height:14px;
  border-radius:8px;
  background:#fff;
  border:3px solid #8c96b2
}
.empty{background:0 0}

#cursoBox{
  position:absolute;
  top:60px;
  left:100%;
  width:40px;
  height:122px;
  background:#4CAF50;
  color:#fff;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  overflow:hidden;
  pointer-events:none
}
#cursoText{
  transform:rotate(-90deg);
  font-size:18px;
  white-space:nowrap
}

#admin-label{
  position:fixed;
  bottom:8px;
  width:100%;
  text-align:center;
  font-size:12px;
  color:#999;
  letter-spacing:2px
}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox">
      <div id="cursoText"></div>
    </div>
  </div>
</div>

<div id="admin-label">admin</div>

<script>
/* =========================
   CONFIG ADMIN
========================= */
const ADMIN_CPF = "35128248895";

/* =========================
   HELPERS
========================= */
const q = s => document.querySelector(s);
const norm = c => c?.toString().replace(/\D/g,"").padStart(11,"0") || "";
const gf = (o,...n)=>{for(const x of n){const k=Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());if(k)return o[k]}};

/* =========================
   ENDPOINTS
========================= */
const GET = "https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";

const map = {AAL:"0046",ALI:"0046",QUI:"0046"};

let currentCurso = "";
let layout = [];
let bl = [];

/* =========================
   FLOW
========================= */
async function fetchFlow(cpf){
  const r = await fetch(GET,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({cpf})
  });
  return r.ok ? r.json() : null;
}

/* =========================
   RENDER
========================= */
function createSeat(v){
  const e = document.createElement("div");
  e.className = v===null ? "empty" : v==="white" ? "seat white" : "seat";
  if(v && v!=="white"){
    e.textContent = v.toString().padStart(2,"0");
    e.dataset.seat = e.textContent;
  }
  return e;
}

function render(layout){
  const w = q(".bus-container");
  w.querySelector(".grid")?.remove();

  const g = document.createElement("div");
  g.className = "grid";

  layout.forEach(r=>{
    r.forEach(v=>{
      const e = createSeat(v);
      if(v && bl.includes(e.dataset.seat)) e.classList.add("white");
      g.appendChild(e);
    });
  });

  w.appendChild(g);
}

/* =========================
   LOAD ADMIN
========================= */
async function loadAdmin(){
  const cpfInput = prompt("CPF ADMIN:");
  if(!cpfInput || norm(cpfInput) !== ADMIN_CPF){
    alert("Acesso negado");
    location.href = "about:blank";
    return;
  }

  const data = await fetchFlow(ADMIN_CPF);
  if(!data){
    alert("Erro ao carregar dados");
    return;
  }

  const cursos = data.codigo || data.cursos || [];
  currentCurso = gf(cursos[0],"CODIGO","Codigo","codigo");
  q("#cursoText").textContent = currentCurso;

  const lista = data.poltronas || data.lista || [];
  const rows = lista.filter(x =>
    gf(x,"CURSO","Curso","curso")?.toUpperCase() === currentCurso
  );

  bl = rows.map(x=>gf(x,"ID","Id","id")?.toString().padStart(2,"0"));

  const cfg = await fetch(`../configs/${map[currentCurso]}.json`).then(r=>r.json());
  layout = cfg.layout;

  render(layout);
  q("#bus-wrapper").style.display = "block";
}

/* =========================
   POLLING ADMIN (30s)
========================= */
setInterval(loadAdmin,30000);

/* =========================
   START
========================= */
loadAdmin();
</script>
</body>
</html>
