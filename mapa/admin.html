<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
body{font-family:Arial;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.8);transform-origin:top center;display:none}
.bus-container{padding:20px 20px 24px 20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center;justify-items:center}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer;user-select:none}
.seat.selected,.seat.mine{background:#e74c3c;border-color:#e74c3c;cursor:default}
.seat.white,.seat.lost,.seat.lost-temp{color:transparent!important;cursor:default!important;pointer-events:none!important}
.seat.white{background:#fff!important;border:3px solid #8c96b2!important}
.seat.lost-temp{background:#aaa!important;border-color:#777!important}
.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}
.seat.lost::before{content:"✖";color:#fff;font-size:28px;font-weight:bold;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
.empty{background:0 0}
#confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;position:absolute;bottom:-64px;right:20px;user-select:none}
#cursoBox{position:absolute;top:60px;left:100%;width:40px;height:122px;background:#4CAF50;color:#fff;font-weight:bold;display:flex;align-items:center;justify-content:center;z-index:9999;overflow:hidden;pointer-events:none}
#cursoText{transform:rotate(-90deg);font-size:18px;white-space:nowrap}
#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:#0001;z-index:9999}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .1s linear}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<!-- MODAL ADMIN -->
<div id="adminModal" style="
display:none;
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%);
background:#d9d9d9;
border-radius:12px;
padding:14px;
width:180px;
z-index:10000;
font-size:13px;
">
  <div id="adminInfo" style="text-align:left"></div>
  <br>
  <div>Deseja alterar a poltrona?</div>
  <div style="margin-top:6px">
    <button id="adminSim">SIM</button>
    <button id="adminNao">NÃO</button>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const CPF_ADMIN = "35128248895";

/* ========= HELPERS ========= */
const q=s=>document.querySelector(s);
const norm=c=>c?.toString().replace(/\D/g,"").padStart(11,"0")||"";
const gf=(o,...n)=>{for(const x of n){const k=Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());if(k)return o[k]}};

let sel=null, bl=[], userSeats=[], currentCPF=null, currentCurso="", layout=[], isLocked=false;
let adminSeat=null;

/* ========= POWER AUTOMATE ========= */
const GET="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";
const POST="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/478aac5453024f5cb3d3b26495d9b7e0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=H6EQYc3xSSZazBjzf0vB_9u5QtwLNj_hnuoBM9CWgz0";
const POST_TROCAR="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1d167b2351e14940acb006f964b87cef/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=V8asrBbmlcMNS9h0ubUJ8Sd8wT02Knni3VOhhU0IjFg";

const map={AAL:"0046",ALI:"0046",QUI:"0046"};

/* ========= ADMIN ========= */
const isAdmin=()=>currentCPF===CPF_ADMIN;

/* ========= CURSO BOX ========= */
setTimeout(()=>q("#cursoBox").style.pointerEvents="auto",0);

let cursoTimer=null;
q("#cursoBox").addEventListener("mousedown",()=>{
  if(!isAdmin()) return;
  cursoTimer=setTimeout(()=>{
    const c=prompt("Código da turma");
    if(c){ currentCurso=c.trim().toUpperCase(); load(); }
  },600);
});
document.addEventListener("mouseup",()=>clearTimeout(cursoTimer));

/* ========= MODAL ========= */
q("#adminNao").onclick=()=>q("#adminModal").style.display="none";
q("#adminSim").onclick=()=>{
  q("#adminModal").style.display="none";
  sel=document.querySelector(`.seat[data-seat="${adminSeat}"]`);
};

/* ========= TOQUE LONGO POLTRONA ========= */
let pressTimer=null;
document.addEventListener("mousedown",e=>{
  if(!isAdmin()) return;
  const s=e.target.closest(".seat:not(.white)");
  if(!s||!s.dataset.seat) return;
  pressTimer=setTimeout(()=>{
    adminSeat=s.dataset.seat;
    q("#adminInfo").innerHTML=
`${adminSeat}<br>
Nome: Nome, Sobrenome<br>
CPF: ${currentCPF.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4")}`;
    q("#adminModal").style.display="block";
  },600);
});
document.addEventListener("mouseup",()=>clearTimeout(pressTimer));

/* ========= POLLING ========= */
setInterval(()=>{ if(isAdmin()&&!isLocked) load(); },30000);

/* ========= LOAD ORIGINAL ========= */
async function load(){
  let cpf=sessionStorage.getItem("cpf");
  if(!cpf){
    cpf=prompt("CPF (somente números)");
    if(!cpf) return;
    sessionStorage.setItem("cpf",cpf);
  }
  currentCPF=norm(cpf);
  const r=await fetch(GET,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf:currentCPF})});
  const j=await r.json();
  const lista=j.poltronas||j.lista||[];
  const cod=j.codigo||j.cursos||[];
  const aluno=cod.find(x=>norm(gf(x,"CPF2","CPF"))===currentCPF);
  currentCurso=gf(aluno,"CODIGO","Codigo","codigo").toUpperCase();
  q("#cursoText").textContent=currentCurso;
  const rows=lista.filter(x=>gf(x,"CURSO","Curso","curso")===currentCurso);
  bl=[...new Set(rows.map(x=>gf(x,"ID","Id","id").padStart(2,"0")))];
  userSeats=rows.filter(x=>norm(gf(x,"CPF2","CPF"))===currentCPF).map(x=>gf(x,"ID","Id","id").padStart(2,"0"));
  const cfg=await fetch(`../configs/${map[currentCurso]||"0046"}.json`).then(r=>r.json());
  layout=cfg.layout;
  render(layout);
  q("#bus-wrapper").style.display="block";
}

/* ========= RENDER ========= */
function render(l){
  const w=q(".bus-container");
  w.querySelector(".grid")?.remove();
  const g=document.createElement("div");
  g.className="grid";
  l.forEach(r=>r.forEach(v=>{
    const e=document.createElement("div");
    e.className=v===null?"empty":v==="white"?"seat white":"seat";
    if(v&&v!=="white"){e.dataset.seat=v.padStart(2,"0");e.textContent=e.dataset.seat;}
    g.appendChild(e);
  }));
  w.appendChild(g);
}

load();
</script>
</body>
</html>
