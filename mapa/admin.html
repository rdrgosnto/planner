<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
/* ===== ORIGINAL (INALTERADO) ===== */
body{font-family:Arial;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.8);transform-origin:top center;display:none}
.bus-container{padding:20px 20px 24px 20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center;justify-items:center}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer;user-select:none}
.seat.selected,.seat.mine{background:#e74c3c;border-color:#e74c3c}
.seat.white{background:#fff!important;border:3px solid #8c96b2!important;color:transparent!important;pointer-events:none}
.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}
.empty{background:none}
#confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;position:absolute;bottom:-64px;right:20px}
#cursoBox{position:absolute;top:60px;left:100%;width:40px;height:122px;background:#4CAF50;color:#fff;font-weight:bold;display:flex;align-items:center;justify-content:center}
#cursoText{transform:rotate(-90deg);font-size:18px}

/* ===== CARD ADMIN (NOVO) ===== */
#seatCard{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:216px;   /* 4 poltronas */
  height:270px;  /* 5 poltronas */
  background:#ccc;
  border-radius:16px;
  display:none;
  z-index:9999;
  padding:12px;
  box-sizing:border-box;
  text-align:center;
  font-size:14px;
}

#seatCard .seat-box{
  width:54px;
  height:54px;
  background:#fff;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  margin-bottom:12px;
}

#seatCard button{
  margin:8px;
  padding:6px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<!-- CARD -->
<div id="seatCard">
  <div class="seat-box" id="cardSeat"></div>
  <div id="cardInfo"></div>
  <br>
  <div>Deseja alterar sua poltrona?</div>
  <br>
  <button>SIM</button>
  <button onclick="closeCard()">N√ÉO</button>
</div>

<script>
const q=s=>document.querySelector(s)
let poltronasData=[]

/* ===== GET ORIGINAL ===== */
async function load(){
  const cpf=sessionStorage.getItem("cpf")
  if(!cpf){location.href="https://rdrgosnto.github.io/planner";return}

  const r=await fetch("https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({cpf})
  })
  const json=await r.json()
  poltronasData=json.poltronas||[]

  q("#bus-wrapper").style.display="block"
}

/* ===== LONG PRESS ===== */
function attachLongPress(el){
  let timer
  el.addEventListener("mousedown",()=>{
    timer=setTimeout(()=>openCard(el.dataset.seat),600)
  })
  el.addEventListener("mouseup",()=>clearTimeout(timer))
  el.addEventListener("mouseleave",()=>clearTimeout(timer))
}

/* ===== CARD ===== */
function openCard(seat){
  const info=poltronasData.find(p=>p.ID?.toString().padStart(2,"0")===seat)
  if(!info) return

  q("#cardSeat").textContent=seat
  q("#cardInfo").innerHTML=`Nome: ${info.NOME || "-"}<br>CPF: ${info.CPF || "-"}`

  q("#seatCard").style.display="block"
}
function closeCard(){
  q("#seatCard").style.display="none"
}

/* ===== OBSERVA POLTRONAS ===== */
const observer=new MutationObserver(()=>{
  document.querySelectorAll(".seat").forEach(s=>{
    if(!s.dataset.lp){
      s.dataset.lp=1
      attachLongPress(s)
    }
  })
})
observer.observe(document.body,{childList:true,subtree:true})

load()
</script>

</body>
</html>
