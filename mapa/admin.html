<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa – Troca Livre</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
body{font-family:Arial;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.8);transform-origin:top center;display:none}
.bus-container{padding:20px 20px 24px 20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center;justify-items:center}

.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer;user-select:none}

.seat.from{background:#f1c40f;border-color:#f1c40f;color:#000}
.seat.to{background:#e74c3c;border-color:#e74c3c}

.seat.white{background:#fff!important;border:3px solid #8c96b2!important;color:transparent}
.seat.lost-temp{background:#aaa!important;border-color:#777!important;color:transparent}

.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}

.empty{background:0 0}

#confirmarBtn{
  width:140px;height:54px;background:#4CAF50;color:#fff;border:none;
  font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;
  position:absolute;bottom:-64px;right:20px
}

#cursoBox{position:absolute;top:60px;left:100%;width:40px;height:122px;background:#4CAF50;color:#fff;font-weight:bold;display:flex;align-items:center;justify-content:center;pointer-events:none}
#cursoText{transform:rotate(-90deg);font-size:18px;white-space:nowrap}

#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:#0001}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .1s linear}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <button id="confirmarBtn">CONFIRMAR TROCA</button>
  </div>
</div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
/* ================= CONFIG ================= */
const MODE = "TROCA_LIVRE";

const GET="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1";
const POST_TROCAR="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1d167b2351e14940acb006f964b87cef/triggers/manual/paths/invoke?api-version=1";

const map={AAL:"0046",ALI:"0046",QUI:"0046"};

const q=s=>document.querySelector(s);
const norm=c=>c?.replace(/\D/g,"").padStart(11,"0")||"";

/* ================= STATE ================= */
let layout=[], currentCurso="";
let exchange={ origem:null, destino:null };
let isLocked=false;

/* ================= UI ================= */
const anim=t=>{
  let w=0;
  (function s(){ if(w<t){w++;q("#progress-bar").style.width=w+"%";requestAnimationFrame(s)} })();
};

const createSeat=v=>{
  const e=document.createElement("div");
  if(v===null){ e.className="empty"; return e }
  e.className="seat";
  e.dataset.seat=v.toString().padStart(2,"0");
  e.textContent=e.dataset.seat;
  e.onclick=()=>onSeatClick(e);
  return e;
};

const render=()=>{
  const box=q(".bus-container");
  box.querySelector(".grid")?.remove();
  const g=document.createElement("div");
  g.className="grid";
  layout.forEach(r=>r.forEach(v=>g.appendChild(createSeat(v))));
  box.appendChild(g);
};

const resetExchange=()=>{
  exchange={origem:null,destino:null};
  document.querySelectorAll(".seat").forEach(s=>{
    s.classList.remove("from","to","lost-temp");
    s.style.pointerEvents="auto";
  });
};

/* ================= LOGIC ================= */
const onSeatClick=e=>{
  if(isLocked) return;
  const id=e.dataset.seat;

  if(!exchange.origem){
    let cpf=prompt(`CPF do ocupante da poltrona ${id} (se livre, deixe vazio):`);
    if(cpf!==null){
      cpf=norm(cpf);
      exchange.origem={ seat:id, cpf:cpf||null };
      e.classList.add("from");
    }
    return;
  }

  if(exchange.origem.seat===id){
    resetExchange();
    return;
  }

  exchange.destino={ seat:id };
  e.classList.add("to");
};

/* ================= CONFIRM ================= */
q("#confirmarBtn").onclick=async()=>{
  if(isLocked) return;
  if(!exchange.origem || !exchange.destino){
    alert("Selecione origem e destino.");
    return;
  }

  const msg=
`Confirma a troca?
CPF: ${exchange.origem.cpf||"(vazio)"}
Origem: ${exchange.origem.seat}
Destino: ${exchange.destino.seat}`;

  if(!confirm(msg)) return;

  isLocked=true;
  document.querySelectorAll(".seat").forEach(s=>s.style.pointerEvents="none");

  try{
    const r=await fetch(POST_TROCAR,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        cpf: exchange.origem.cpf,
        curso: currentCurso,
        current: exchange.origem.seat,
        select: exchange.destino.seat
      })
    });

    if(r.ok){
      alert("Troca realizada com sucesso!");
      resetExchange();
    }else{
      alert("Erro: dados não conferem ou poltrona indisponível.");
    }
  }catch{
    alert("Erro de comunicação.");
  }

  isLocked=false;
};

/* ================= LOAD ================= */
(async()=>{
  anim(30);
  const cpf=sessionStorage.getItem("cpf")||"00000000000";
  const r=await fetch(GET,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf})});
  const j=await r.json();
  currentCurso=j.codigo?.[0]?.CODIGO?.toUpperCase()||"";
  q("#cursoText").textContent=currentCurso;

  const cfg=await fetch(`../configs/${map[currentCurso]||"0046"}.json`).then(r=>r.json());
  layout=cfg.layout;

  render();
  anim(100);
  setTimeout(()=>q("#progress-bar-container").remove(),500);
  q("#bus-wrapper").style.display="block";
})();
</script>

</body>
</html>
