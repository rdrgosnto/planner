<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
body{
  font-family:Arial;
  margin:0;
  padding:0;
  display:flex;
  flex-direction:column;
  min-height:100vh;
  justify-content:center;
  background:#fff
}
#bus-wrapper{
  transform:scale(.8);
  transform-origin:top center;
  display:none
}
.bus-container{
  padding:20px 20px 24px;
  border:3px solid #b0b0b0;
  border-radius:16px;
  width:fit-content;
  margin:20px auto;
  position:relative;
  display:flex;
  justify-content:center
}
.grid{
  display:grid;
  grid-template-columns:repeat(5,54px);
  gap:14px 10px;
  justify-content:center;
  justify-items:center
}
.seat,.empty{
  width:54px;
  height:54px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  position:relative
}
.seat{
  background:#4CAF50;
  border:3px solid #4CAF50;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
  user-select:none
}
.seat.selected,.seat.mine{
  background:#e74c3c;
  border-color:#e74c3c;
  cursor:default
}
.seat.white,.seat.lost,.seat.lost-temp{
  color:transparent!important;
  cursor:default!important;
  pointer-events:none!important
}
.seat.white{
  background:#fff!important;
  border:3px solid #8c96b2!important
}
.seat.lost-temp{
  background:#aaa!important;
  border-color:#777!important
}
.seat::after{
  content:"";
  position:absolute;
  bottom:-8px;
  left:50%;
  transform:translateX(-50%);
  width:32px;
  height:14px;
  border-radius:8px;
  background:#fff;
  border:3px solid #8c96b2
}
.empty{background:none}

#confirmarBtn{
  width:112px;
  height:54px;
  background:#4CAF50;
  color:#fff;
  border:none;
  font-size:16px;
  font-weight:bold;
  border-radius:12px;
  cursor:pointer;
  position:absolute;
  bottom:-64px;
  right:20px;
  user-select:none
}

#cursoBox{
  position:absolute;
  top:60px;
  left:100%;
  width:40px;
  height:122px;
  background:#4CAF50;
  color:#fff;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  overflow:hidden;
  pointer-events:none
}
#cursoText{
  transform:rotate(-90deg);
  font-size:18px;
  white-space:nowrap
}

#progress-bar-container{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  height:8px;
  background:#0001;
  z-index:9999
}
#progress-bar{
  width:0;
  height:100%;
  background:#4CAF50;
  transition:width .1s linear
}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
const q = s => document.querySelector(s)
const norm = c => c?.toString().replace(/\D/g,"").padStart(11,"0") || ""
const gf = (o,...n)=>{for(const x of n){const k=Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());if(k)return o[k]}}

let sel=null, bl=[], userSeats=[], currentCPF=null, currentCurso="", layout=[], isLocked=false
let isDragging=false

const GET="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1"
const POST="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/478aac5453024f5cb3d3b26495d9b7e0/triggers/manual/paths/invoke?api-version=1"
const POST_TROCAR="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1d167b2351e14940acb006f964b87cef/triggers/manual/paths/invoke?api-version=1"

const map={AAL:"0046",ALI:"0046",QUI:"0046"}

const canSelect = e =>
  e &&
  e.classList.contains("seat") &&
  !e.classList.contains("white") &&
  !e.classList.contains("mine") &&
  !e.classList.contains("lost-temp")

const selectSeat = e => {
  if(!canSelect(e)) return
  sel?.classList.remove("selected")
  sel=e
  sel.classList.add("selected")
}

document.addEventListener("mouseup",()=>isDragging=false)

const cSeat=v=>{
  const e=document.createElement("div")
  e.className=v===null?"empty":"seat"
  if(v && v!=="white"){
    e.dataset.seat=v.toString().padStart(2,"0")
    e.textContent=e.dataset.seat
  }
  return e
}

const render=l=>{
  const w=q(".bus-container")
  w.querySelector(".grid")?.remove()
  const g=document.createElement("div")
  g.className="grid"

  l.forEach(row=>row.forEach(v=>{
    const e=cSeat(v)
    if(v){
      const id=e.dataset.seat
      if(userSeats.includes(id)) e.classList.add("mine")
      else if(bl.includes(id)) e.classList.add("white")
      else{
        e.onmousedown=()=>{if(isLocked)return;isDragging=true;selectSeat(e)}
        e.onmouseenter=()=>{if(isDragging)selectSeat(e)}
      }
    }
    g.appendChild(e)
  }))
  w.appendChild(g)
}

q("#confirmarBtn").onclick=async()=>{
  if(!sel) return alert("Selecione uma poltrona.")
  alert("Poltrona pronta para confirmar.\n(arrastar funcionando corretamente)")
}

q("#bus-wrapper").style.display="block"
</script>

</body>
</html>
