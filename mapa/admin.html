<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<style>
body{font-family:Arial;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center}
#bus-wrapper{transform:scale(.8);transform-origin:top center;display:none}
.bus-container{padding:20px 20px 24px;border:3px solid #b0b0b0;border-radius:16px;margin:auto;position:relative}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px}
.seat,.empty{width:54px;height:54px;border-radius:12px;display:flex;align-items:center;justify-content:center}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer}
.seat.mine{background:#e74c3c;border-color:#e74c3c}
.seat.white{background:#fff;border:3px solid #8c96b2;color:transparent;pointer-events:none}
#confirmarBtn{position:absolute;bottom:-64px;right:20px;width:112px;height:54px;border-radius:12px;border:none;background:#4CAF50;color:#fff;font-weight:bold}
#cursoBox{position:absolute;top:60px;left:100%;width:40px;height:122px;background:#4CAF50;color:#fff;display:flex;align-items:center;justify-content:center}
#cursoText{transform:rotate(-90deg);font-size:18px}
#adminLabel{position:fixed;bottom:6px;left:50%;transform:translateX(-50%);font-size:11px;color:#888}

/* ADMIN BOX */
#adminOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999}
#adminBox{width:190px;height:130px;background:#d0d0d0;border:3px solid #8c96b2;border-radius:12px;padding:10px;font-size:14px}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<div id="adminOverlay">
  <div id="adminBox">
    <b>Reservado</b><br>
    <span id="adminCPF"></span><br><br>
    Deseja mudar a poltrona?<br>
    <button id="adminYes">SIM</button>
    <button id="adminNo">NÃO</button>
  </div>
</div>

<div id="adminLabel">admin</div>

<script>
/* ===== BASE ORIGINAL (PRESERVADA) ===== */
const q=s=>document.querySelector(s),
norm=c=>c?.toString().replace(/\D/g,"").padStart(11,"0")||"",
gf=(o,...n)=>{for(const x of n){const k=Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());if(k)return o[k]}};

let sel=null, bl=[], userSeats=[], currentCPF=null, currentCurso="", layout=[], isLocked=false;

const GET="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1";

/* ===== ADMIN ===== */
const ADMIN_CPF="35128248895";
const isAdmin=norm(sessionStorage.getItem("cpf"))===ADMIN_CPF;

/* ===== FETCH CORRETO ===== */
const fetchFlow=async(u,c)=>{try{
  const r=await fetch(u,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({cpf:c})
  });
  return{ok:r.ok,json:r.ok?await r.json():null}
}catch{return{ok:0}}};

/* ===== RENDER ORIGINAL ===== */
const cSeat=v=>{
  const e=document.createElement("div");
  e.className=v===null?"empty":"seat";
  if(v){
    e.dataset.seat=v.toString().padStart(2,"0");
    e.textContent=e.dataset.seat;
    if(userSeats.includes(e.dataset.seat)) e.classList.add("mine");
    else if(bl.includes(e.dataset.seat)) e.classList.add("white");
  }
  return e;
};

const render=l=>{
  const w=q(".bus-container");
  w.querySelector(".grid")?.remove();
  const g=document.createElement("div");
  g.className="grid";
  l.forEach(row=>row.forEach(v=>g.appendChild(cSeat(v))));
  w.appendChild(g);
};

/* ===== LOAD ORIGINAL ===== */
const load=async()=>{
  const cpf=sessionStorage.getItem("cpf");
  if(!cpf) return;
  currentCPF=norm(cpf);

  const r=await fetchFlow(GET,currentCPF);
  if(!r.ok) return;

  const lista=r.json.poltronas||[];
  const cursos=r.json.codigo||[];
  const aluno=cursos.find(x=>norm(gf(x,"CPF2","CPF"))===currentCPF);
  if(!aluno) return;

  if(!currentCurso){
    currentCurso=gf(aluno,"CODIGO","Codigo","codigo").toUpperCase();
  }

  q("#cursoText").textContent=currentCurso;

  const rows=lista.filter(x=>gf(x,"CURSO","Curso","curso")===currentCurso);
  bl=rows.map(x=>gf(x,"ID","Id","id").toString().padStart(2,"0"));
  userSeats=rows.filter(x=>norm(gf(x,"CPF2","CPF"))===currentCPF)
                .map(x=>gf(x,"ID","Id","id").toString().padStart(2,"0"));

  layout=(await fetch("../configs/0046.json").then(r=>r.json())).layout;
  render(layout);
  q("#bus-wrapper").style.display="block";
};

/* ===== POLLING ADMIN ===== */
if(isAdmin){
  setInterval(load,30000);
}

/* ===== TROCA DE TURMA ADMIN ===== */
if(isAdmin){
  document.addEventListener("keydown",e=>{
    if(e.key==="Enter"){
      const t=prompt("Código da turma:");
      if(t){
        currentCurso=t.trim().toUpperCase();
        load();
      }
    }
  });
}

load();
</script>
</body>
</html>
