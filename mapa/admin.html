<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa Admin</title>

<style>
body{font-family:Arial;margin:0;padding:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}
#bus-wrapper{transform:scale(.8);transform-origin:top center;display:none}
.bus-container{padding:20px 20px 24px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer}
.seat.white{background:#fff;border-color:#8c96b2;color:transparent;pointer-events:none}
.empty{background:none}

/* ==== MODAL ADMIN ==== */
#adminModal{
  position:fixed;
  inset:0;
  background:#0006;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#adminBox{
  background:#fff;
  padding:20px;
  border-radius:14px;
  width:260px;
  text-align:center;
  box-shadow:0 10px 30px #0004;
}
#adminBox b{display:block;margin:6px 0}
#adminBox button{
  margin:10px 6px;
  padding:8px 14px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}
.btnYes{background:#4CAF50;color:#fff}
.btnNo{background:#ccc}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container"></div>
</div>

<!-- MODAL ADMIN -->
<div id="adminModal">
  <div id="adminBox">
    <div id="adminInfo"></div>
    <button class="btnYes">SIM</button>
    <button class="btnNo">N√ÉO</button>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const ADMIN_CPF = "35128248895";
const GET = "https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";
const POST_TROCAR="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1d167b2351e14940acb006f964b87cef/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=V8asrBbmlcMNS9h0ubUJ8Sd8wT02Knni3VOhhU0IjFg";
const MAP_FILE="../configs/0046.json";

/* ===== HELPERS ===== */
const q=s=>document.querySelector(s);
const norm=c=>c.replace(/\D/g,"").padStart(11,"0");

/* ===== STATE ===== */
let data=[], seats={}, selectedSeat=null, pressTimer=null;

/* ===== ADMIN LOGIN ===== */
const cpf = norm(prompt("Digite o CPF do administrador:")||"");
if(cpf!==ADMIN_CPF){
  alert("Acesso negado");
  location.href="about:blank";
}

/* ===== LOAD MAP ===== */
async function loadAdmin(){
  const r = await fetch(GET,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf:ADMIN_CPF})});
  const j = await r.json();
  data = j.poltronas || j.lista || [];
  seats = {};
  data.forEach(x=>{
    const id=x.ID?.toString().padStart(2,"0");
    if(id) seats[id]=x;
  });

  const cfg = await fetch(MAP_FILE).then(r=>r.json());
  render(cfg.layout);
  q("#bus-wrapper").style.display="block";
}

function render(layout){
  const c=q(".bus-container");
  c.innerHTML="";
  const g=document.createElement("div");
  g.className="grid";
  layout.flat().forEach(v=>{
    const d=document.createElement("div");
    if(!v){d.className="empty";}
    else{
      d.className="seat";
      d.textContent=v;
      const id=v.toString().padStart(2,"0");
      if(seats[id]){
        d.onmousedown=e=>startPress(e,id);
        d.onmouseup=clearPress;
        d.ontouchstart=e=>startPress(e,id);
        d.ontouchend=clearPress;
      }
    }
    g.appendChild(d);
  });
  c.appendChild(g);
}

/* ===== LONG PRESS ===== */
function startPress(e,id){
  e.preventDefault();
  pressTimer=setTimeout(()=>openAdmin(id),600);
}
function clearPress(){clearTimeout(pressTimer);}

/* ===== MODAL ===== */
function openAdmin(id){
  selectedSeat=id;
  const aluno=seats[id];
  q("#adminInfo").innerHTML=`Poltrona <b>${id}</b><br>CPF<br><b>${aluno.CPF2||aluno.CPF}</b><br><br>Deseja mudar a poltrona?`;
  q("#adminModal").style.display="flex";
}

q(".btnNo").onclick=()=>q("#adminModal").style.display="none";

q(".btnYes").onclick=async()=>{
  q("#adminModal").style.display="none";
  const nova=prompt("Nova poltrona:");
  if(!nova) return;
  await fetch(POST_TROCAR,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      cpf:seats[selectedSeat].CPF2||seats[selectedSeat].CPF,
      curso:seats[selectedSeat].CURSO,
      current:selectedSeat,
      select:nova.padStart(2,"0")
    })
  });
  loadAdmin();
};

/* ===== INIT ===== */
loadAdmin();
setInterval(loadAdmin,30000);
</script>
</body>
</html>
