<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

<script>
if(location.pathname.endsWith("index.html")){
  location.replace(location.pathname.replace("index.html",""));
}
</script>

<style>
body{
  font-family:Arial;
  margin:0;
  padding:0;
  display:flex;
  flex-direction:column;
  min-height:100vh;
  justify-content:center;
  background:#fff;
}

/* ðŸ”§ CORREÃ‡ÃƒO AQUI */
#bus-wrapper{
  transform:scale(.8); /* antes era 1 */
  transform-origin:top center;
  visibility:hidden;
}

.bus-container{
  padding:20px;
  border:3px solid #b0b0b0;
  border-radius:16px;
  width:fit-content;
  margin:20px auto;
  position:relative;
  display:flex;
  justify-content:center;
}

.grid{
  display:grid;
  grid-template-columns:repeat(5,54px);
  gap:14px 10px;
  justify-content:center;
  justify-items:center;
}

.seat,.empty{
  width:54px;
  height:54px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  position:relative;
}

.seat{
  background:#4CAF50;
  border:3px solid #4CAF50;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}

.seat::after{
  content:"";
  position:absolute;
  bottom:-8px;
  left:50%;
  transform:translateX(-50%);
  width:32px;
  height:14px;
  border-radius:8px;
  background:#fff;
  border:3px solid #8c96b2;
}

.seat.white{
  background:#fff!important;
  border:3px solid #8c96b2!important;
  color:transparent!important;
  cursor:default!important;
  pointer-events:none!important;
}

.seat.white::after{
  border-color:#8c96b2!important;
}

.seat.selected{
  background:#e74c3c;
  border-color:#e74c3c;
}

.empty{
  background:transparent;
}

.seat.lost{
  background:#b0b0b0!important;
  border-color:#b0b0b0!important;
  color:transparent!important;
  pointer-events:none!important;
}

.seat.lost::before{
  content:"âœ–";
  color:#fff;
  font-size:28px;
  font-weight:bold;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
}

#progress-bar-container{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  height:8px;
  background:#0001;
  z-index:9999;
}

#progress-bar{
  width:0;
  height:100%;
  background:#4CAF50;
  transition:width .1s linear;
}

#confirmarBtn{
  width:112px;
  height:54px;
  background:#4CAF50;
  color:#fff;
  border:none;
  font-size:16px;
  font-weight:bold;
  border-radius:12px;
  cursor:pointer;
  position:absolute;
  bottom:-64px;
  right:20px;
}

#cursoBox{
  position:absolute;
  top:60px;
  left:100%;
  width:40px;
  height:122px;
  background:#4CAF50;
  color:#fff;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  overflow:hidden;
  pointer-events:none;
}

#cursoText{
  transform:rotate(-90deg);
  font-size:18px;
  white-space:nowrap;
}
</style>
</head>

<body>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox">
      <div id="cursoText"></div>
    </div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<div id="progress-bar-container">
  <div id="progress-bar"></div>
</div>

<script>
(() => {
  if(!sessionStorage.getItem("cacheStamp")){
    sessionStorage.setItem("cacheStamp",Date.now());
  }
})();

const q=(s,d=document)=>d.querySelector(s);
const normCPF=c=>c?.toString().replace(/\D/g,"").padStart(11,"0")||"";

const cSeat=v=>{
  const e=document.createElement("div");
  if(v===null){e.className="empty";return e}
  if(v==="white"){e.className="seat white";return e}
  e.className="seat";
  e.textContent=v.toString().padStart(2,"0");
  return e;
};

const selSeat=e=>{
  if(e.classList.contains("white")||e.classList.contains("lost"))return;
  sel?.classList.remove("selected");
  sel = e!==sel ? (e.classList.add("selected"),e) : null;
};

let sel=null,bl=[],rb=[],rbSet=new Set(),userBlockedSeats=[],fakeBlockedSeats=[];
let currentUserCPF=null,currentCurso="",currentBus="",layout=[];

/* ðŸ” CPF */
const cpfStored=sessionStorage.getItem("cpf");
if(!cpfStored){
  location.href="https://rdrgosnto.github.io/planner";
  throw "";
}
currentUserCPF=normCPF(cpfStored);

/* ðŸ” RENDER */
const render=l=>{
  const w=q(".bus-container");
  w.querySelector(".grid")?.remove();
  const g=document.createElement("div");
  g.className="grid";
  const frag=document.createDocumentFragment();

  for(const row of l){
    for(const v of row){
      const e=cSeat(v);
      if(v!==null&&v!=="white"){
        const id=v.toString().padStart(2,"0");
        e.dataset.seat=id;
        if(bl.includes(id)||userBlockedSeats.includes(id)||fakeBlockedSeats.includes(id)||rbSet.has(id)){
          e.classList.add("white");
        }else{
          e.onclick=()=>selSeat(e);
        }
      }
      frag.appendChild(e);
    }
  }

  g.appendChild(frag);
  w.appendChild(g);
};

/* ðŸš€ SIMULAÃ‡ÃƒO DE LAYOUT (0046 / 46 POLTRONAS) */
const fakeLayout = [
 [1,2,null,3,4],
 [5,6,null,7,8],
 [9,10,null,11,12],
 [13,14,null,15,16],
 [17,18,null,19,20],
 [21,22,null,23,24],
 [25,26,null,27,28],
 [29,30,null,31,32],
 [33,34,null,35,36],
 [37,38,null,39,40],
 [41,42,null,"white","white"]
];

/* ðŸ”„ LOAD */
setTimeout(()=>{
  render(fakeLayout);
  q("#bus-wrapper").style.visibility="visible";
  q("#progress-bar-container").remove();
},400);
</script>

</body>
</html>
