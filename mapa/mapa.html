<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Planner</title>
    <style>
        body{font-family:Arial;margin:0;display:flex;flex-direction:column;min-height:100vh;justify-content:center;background:#fff}#w{transform:scale(.8);transform-origin:top center;display:none}.bc{padding:20px 20px 24px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center}.g{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center}.s,.e{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}.s{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:700;cursor:pointer;user-select:none}.s.selected,.s.mine{background:#e74c3c;border-color:#e74c3c;cursor:default}.s.white,.s.lt{color:transparent!important;pointer-events:none!important}.s.white{background:#fff!important;border:3px solid #8c96b2!important}.s.lt{background:#aaa!important;border-color:#777!important}.s::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}.e{background:0 0}#btn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:700;border-radius:12px;cursor:pointer;position:absolute;bottom:-64px;right:20px}#btn:disabled{opacity:.6}#cbx{position:absolute;top:60px;left:100%;width:40px;height:122px;background:#4CAF50;color:#fff;font-weight:700;display:flex;align-items:center;justify-content:center;pointer-events:none}#ctx{transform:rotate(-90deg);font-size:18px;white-space:nowrap}#pbc{position:fixed;bottom:0;width:100%;height:8px;background:#0001}#pb{width:0;height:100%;background:#4CAF50;transition:width .1s}
    </style>
</head>
<body>
    <div id="w">
        <div class="bc">
            <div id="cbx"><div id="ctx"></div></div>
            <button id="btn">CONFIRMAR</button>
        </div>
    </div>
    <div id="pbc"><div id="pb"></div></div>

<script>
    const q=s=>document.querySelector(s),nm=c=>c?.toString().replace(/\D/g,"").padStart(11,"0")||"",gf=(o,...n)=>{for(let x of n){let k=Object.keys(o||{}).find(z=>z.toLowerCase()===x.toLowerCase());if(k)return o[k]}};let sel=null,bl=[],us=[],cpf=null,cur="",lock=false;const B="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/",E="/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=",U={G:`${B}239ef024d32946f99a66585bed86d236${E}ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA`,P:`${B}478aac5453024f5cb3d3b26495d9b7e0${E}H6EQYc3xSSZazBjzf0vB_9u5QtwLNj_hnuoBM9CWgz0`,S:`${B}1d167b2351e14940acb006f964b87cef${E}V8asrBbmlcMNS9h0ubUJ8Sd8wT02Knni3VOhhU0IjFg`},cmap={AAL:"0046",ALI:"0046",QUI:"0046"};const an=t=>{let b=q("#pb"),w=0,i=setInterval(()=>{w>=t?clearInterval(i):(w++,b.style.width=w+"%")},10)},rd=l=>{const c=q(".bc"),o=q(".g");o&&o.remove();const g=document.createElement("div");g.className="g";l.forEach(r=>r.forEach(v=>{const e=document.createElement("div");if(v===null)e.className="e";else{e.className="s";const id=v.toString().padStart(2,"0");if(v!=="white"){e.textContent=id;e.dataset.s=id}if(us.includes(id))e.classList.add("mine");else if(bl.includes(id)||v==="white")e.classList.add("white");else e.onclick=()=>sl(e)}g.appendChild(e)}));c.appendChild(g)},sl=e=>{if(lock||e.classList.contains("white")||e.classList.contains("mine")||e.classList.contains("lt"))return;if(sel)sel.classList.remove("selected");sel=(sel===e)?null:e;if(sel)sel.classList.add("selected")},ld=async()=>{const c=sessionStorage.getItem("cpf");if(!c)return location.href="https://rdrgosnto.github.io/planner";cpf=nm(c);an(40);try{const r=await fetch(U.G,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf})}),d=await r.json();an(70);const l=d.poltronas||d.lista||[],s=d.codigo||d.cursos||[],a=s.find(x=>nm(gf(x,"CPF2","CPF"))===cpf);if(!a)return alert("CPF não achado");cur=gf(a,"CODIGO","Codigo").toString().trim().toUpperCase();q("#ctx").textContent=cur;const rows=l.filter(x=>gf(x,"CURSO","Curso")?.toString().trim().toUpperCase()===cur);bl=[...new Set(rows.map(x=>gf(x,"ID","Id")?.toString().padStart(2,"0")).filter(Boolean))];us=rows.filter(x=>nm(gf(x,"CPF2","CPF"))===cpf).map(x=>gf(x,"ID","Id").toString().padStart(2,"0"));const cfg=await fetch(`../configs/${cmap[cur]||"0046"}.json`).then(r=>r.json());rd(cfg.layout);an(100);setTimeout(()=>{
        q("#pbc").remove();
        q("#w").style.display="block";
        
        // ALTERA A URL NA BARRA DE ENDEREÇOS SEM RECARREGAR
        window.history.replaceState({}, '', 'https://rdrgosnto.github.io/planner');
        
    },600)}catch(e){alert("Erro")}};q("#btn").onclick=async()=>{if(lock||!sel)return!sel&&alert("Selecione uma poltrona");if(!confirm("Confirma troca de poltrona?"))return;lock=true;q("#btn").disabled=true;const n=sel.dataset.s,old=us[0]||null,el=sel;try{const p=old?{cpf,curso:cur,current:old,select:n}:{poltrona:n,CURSO:cur,cpf},r=await fetch(old?U.S:U.P,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(r.ok){if(old){let oE=q(`.s[data-s="${old}"]`);if(oE){oE.classList.remove("mine");oE.onclick=()=>sl(oE)}}el.classList.remove("selected");el.classList.add("mine");us=[n];alert("Poltrona selecionada com sucesso!");lock=false;q("#btn").disabled=false;sel=null}else{alert("Poltrona ocupada por outro usuário");el.classList.remove("selected");el.classList.add("lt");setTimeout(()=>{el.classList.remove("lt");el.classList.add("white")},9000);lock=false;q("#btn").disabled=false;sel=null}}catch(e){alert("Erro");lock=false;q("#btn").disabled=false}};ld();
</script>
</body>
</html>
