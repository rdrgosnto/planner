<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Seat</title>
<style>
/* Geral */
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#fff;display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column;overflow:hidden}
#splash{position:fixed;inset:0;z-index:9;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#fff}
#splash b{font-size:36px;color:#4CAF50;margin-bottom:10px}
#splash i{width:120px;height:2px;background:#e0e0e0;overflow:hidden}
#splash i:after{content:"";display:block;width:40px;height:100%;background:#4CAF50;animation:l .9s infinite}
@keyframes l{from{transform:translateX(-40px)}to{transform:translateX(120px)}}

/* Login */
.app{width:90%;max-width:300px;display:none;flex-direction:column}
label{font-size:16px;color:#333;margin:0 0 6px 2px}
.row{display:flex;align-items:center;gap:8px;border-bottom:1px solid #ccc}
.row:focus-within{border-color:#ccc}
.row.err{border-color:#e53935}
.row.ok{border-color:#4CAF50}
input{flex:1 1 auto;min-width:0;border:0;padding:10px 2px;font-size:18px;background:0;outline:0}
input::placeholder{font-size:16px;color:#999}
button{flex:0 0 auto;max-width:35%;padding:6px 12px;border:1px solid #aaa;border-radius:20px;background:0;color:#aaa;font-size:14px;font-weight:bold;white-space:nowrap}
button.ready{background:#4CAF50;color:#fff;border-color:#4CAF50;cursor:pointer}
button.ready:active{background:#43a047;transform:scale(.97)}
.errmsg{font-size:13px;color:#e53935;margin:14px 0 0 2px;display:none}

/* Mapa */
#bus-wrapper{transform:scale(.8);transform-origin:top center;display:none;flex-direction:column;align-items:center}
.bus-container{padding:20px;border:3px solid #b0b0b0;border-radius:16px;width:fit-content;margin:20px auto;position:relative;display:flex;justify-content:center;flex-direction:column;align-items:center}
.grid{display:grid;grid-template-columns:repeat(5,54px);gap:14px 10px;justify-content:center;justify-items:center;margin-bottom:20px}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer}
.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}
.seat.white{background:#fff!important;border:3px solid #8c96b2!important;color:transparent!important;cursor:default!important;pointer-events:none!important}
.seat.white::after{border-color:#8c96b2!important}
.seat.selected{background:#e74c3c;border-color:#e74c3c}
.empty{background:0 0}
.seat.lost{background:#b0b0b0!important;border-color:#b0b0b0!important;color:transparent!important;pointer-events:none!important}
.seat.lost::before{content:"✖";color:#fff;font-size:28px;font-weight:bold;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:#0001;z-index:9999}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .1s linear}
#confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;margin-top:10px}
#cursoText{font-size:18px;font-weight:bold;margin-bottom:10px}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash"><b>Planner</b><i></i></div>

<!-- Login -->
<div class="app">
  <label>CPF</label>
  <div class="row">
    <input id="cpf" placeholder="CPF (somente números)" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
    <button id="btn" disabled>ENTRAR</button>
  </div>
  <div class="errmsg" id="err"></div>
</div>

<!-- Mapa -->
<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoText"></div>
    <div class="grid"></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
(async()=>{
  /* SPLASH */
  await new Promise(r=>setTimeout(r,1600));
  document.getElementById("splash").remove();
  const app = document.querySelector(".app");
  app.style.display = "flex";

  const $ = (s,d=document)=>d.querySelector(s);
  let timer = null;
  const DEBOUNCE = 400;

  const norm = v=>v.replace(/\D/g,"").padStart(11,"0");
  const valido = c=>{
    c=c.replace(/\D/g,"");
    if(!c || c.length!==11 || /^(\d)\1+$/.test(c)) return false;
    let sum=0, rest;
    for(let i=1;i<=9;i++) sum+=parseInt(c[i-1])*(11-i);
    rest=(sum*10)%11; if(rest===10) rest=0;
    if(rest!==parseInt(c[9])) return false;
    sum=0; for(let i=1;i<=10;i++) sum+=parseInt(c[i-1])*(12-i);
    rest=(sum*10)%11; if(rest===10) rest=0;
    return rest===parseInt(c[10]);
  };

  const setRow = state => {
    const row = $(".row");
    row.className="row";
    if(state) row.classList.add(state);
  };

  /* LOGIN */
  const cpf = $("#cpf"), btn = $("#btn"), err = $("#err");
  cpf.oninput = ()=>{
    const nums = cpf.value.replace(/\D/g,"");
    cpf.value = nums;
    btn.disabled = true; btn.className=""; setRow();
    if(timer) clearTimeout(timer);
    if(!nums){err.style.display="none"; return;}
    if(nums.length<11 || !valido(nums)){err.textContent="CPF inválido"; err.style.display="block"; setRow("err"); return;}
    err.style.display="none";
    timer = setTimeout(async()=>{
      try{
        const r = await fetch("https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA",
          {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf:nums})});
        const data = r.ok ? await r.json() : null;
        const autorizado = (data?.codigo || []).find(x=>norm(x.CPF2||x.CPF)===nums && String(x.ID).trim()==="#");
        if(!autorizado) throw 0;
        btn.disabled=false; btn.classList.add("ready"); setRow("ok");
      }catch{
        err.textContent="CPF não autorizado"; err.style.display="block"; setRow("err"); btn.disabled=true;
      }
    }, DEBOUNCE);
  };

  /* MAPA */
  const busWrapper = $("#bus-wrapper"), progress = $("#progress-bar"), confirmarBtn = $("#confirmarBtn"), cursoText = $("#cursoText");
  let sel = null, layout = [], currentUserCPF="", currentCurso="", currentBus="";
  const map = {AAL:"0046",ALI:"0046",QUI:"0046"};

  const anim = t => { let w=parseFloat(progress.style.width)||0; (function s(){w<t?(w++,progress.style.width=w+"%",requestAnimationFrame(s)):0})() };
  const fetchJSON = async url => { try{const r=await fetch(url); return r.ok?await r.json():null;}catch{return null;} };
  const cSeat = v => { const e=document.createElement("div"); if(v===null) e.className="empty"; else if(v==="white") e.className="seat white"; else { e.className="seat"; e.textContent=v.toString().padStart(2,"0"); } return e; };
  const selSeatFunc = e=>{ if(e.classList.contains("white")||e.classList.contains("lost")) return; sel?.classList.remove("selected"); sel = e!==sel?(e.classList.add("selected"),e):null; };
  const render = l => { const g=$(".grid"); g.innerHTML=""; const frag=document.createDocumentFragment(); for(const row of l) for(const v of row){const e=cSeat(v); if(v!==null && v!=="white") e.onclick=()=>selSeatFunc(e); frag.appendChild(e);} g.appendChild(frag); };

  const loadMap = async ()=>{
    anim(20);
    try{
      const r = await fetch("https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA",
        {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf:currentUserCPF})});
      const data = r.ok ? await r.json() : null;
      if(!data) throw new Error("Erro ao consultar fluxo");
      anim(50);
      const lista = data.poltronas || data.lista || [];
      const aluno = (data.codigo||[]).find(x=>norm(x.CPF2||x.CPF)===currentUserCPF);
      if(!aluno) throw new Error("CPF não encontrado");
      currentCurso = (aluno.CODIGO||aluno.codigo||aluno.Codigo||"").toString().trim().toUpperCase();
      currentBus = map[currentCurso]||"0046"; cursoText.textContent=currentCurso;
      anim(70);
      const cfg = await fetchJSON(`../configs/${currentBus}.json`);
      if(!cfg?.layout) throw new Error("Layout não encontrado");
      layout = cfg.layout;
      render(layout);
      anim(100);
      setTimeout(()=>$("#progress-bar-container").remove(),600);
      busWrapper.style.display="flex";
    }catch(err){
      alert(err.message);
      busWrapper.innerHTML=`<p style="color:red;font-weight:bold;">Erro ao carregar mapa.</p>`;
      busWrapper.style.display="flex";
    }
  };

  btn.onclick = ()=>{
    if(btn.disabled) return;
    currentUserCPF = norm(cpf.value);
    app.style.display="none";
    loadMap();
  };

  confirmarBtn.onclick = ()=>{
    if(!sel){alert("Selecione uma poltrona."); return;}
    alert(`Poltrona selecionada: ${sel.dataset.seat || sel.textContent}`);
  };
})();
</script>
</body>
</html>
