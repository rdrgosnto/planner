<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Mapa</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<style>
body{
  font-family: Arial;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  justify-content: center;
  align-items: center;
  background: #fff;
  position: relative;
}
#bus-wrapper{
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}
.bus-container{
  padding: 20px;
  border: 3px solid #b0b0b0;
  border-radius: 16px;
  width: fit-content;
  display: flex;
  justify-content: center;
  position: relative;
}
.grid{
  display: grid;
  grid-template-columns: repeat(5,54px);
  gap: 14px 10px;
  justify-content: center;
  justify-items: center;
}
.seat,.empty{
  width: 54px;
  height: 54px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  position: relative;
}
.seat{
  background: #4CAF50;
  border: 3px solid #4CAF50;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
}
.seat::after{
  content: "";
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 32px;
  height: 14px;
  border-radius: 8px;
  background: #fff;
  border: 3px solid #8c96b2;
}
.seat.white{
  background: #fff!important;
  border: 3px solid #8c96b2!important;
  color: transparent!important;
  cursor: default!important;
  pointer-events: none!important;
}
.seat.white::after{
  border-color: #8c96b2!important;
}
.seat.selected{
  background: #e74c3c;
  border-color: #e74c3c;
}
.seat.lost{
  background: #b0b0b0!important;
  border-color: #b0b0b0!important;
  color: transparent!important;
  pointer-events: none!important;
}
.seat.lost::before{
  content: "✖";
  color: #fff;
  font-size: 28px;
  font-weight: bold;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
.empty{
  background: none;
}
#progress-bar-container{
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 8px;
  background: #0001;
  z-index: 9999;
}
#progress-bar{
  width: 0;
  height: 100%;
  background: #4CAF50;
  transition: width .1s linear;
}
/* Elementos fora do container */
#cursoBox{
  position: absolute;
  width: 40px;
  height: 122px;
  background: #4CAF50;
  color: #fff;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  z-index: 9999;
}
#cursoText{
  transform: rotate(-90deg);
  font-size: 18px;
  white-space: nowrap;
}
#confirmarBtn{
  position: absolute;
  width: 112px;
  height: 54px;
  background: #4CAF50;
  color: #fff;
  border: none;
  font-size: 16px;
  font-weight: bold;
  border-radius: 12px;
  cursor: pointer;
  z-index: 9999;
}
</style>
</head>
<body>
<div id="bus-wrapper">
  <div class="bus-container" id="busContainer">
    <div id="gridPlaceholder"></div>
  </div>
  <div id="cursoBox"><div id="cursoText"></div></div>
  <button id="confirmarBtn">CONFIRMAR</button>
</div>
<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
const q=(s,d=document)=>d.querySelector(s);
const normCPF=c=>c?.toString().replace(/\D/g,"").padStart(11,"0")||"";
const cSeat=v=>{const e=document.createElement("div");if(v===null)e.className="empty";else if(v==="white")e.className="seat white";else{e.className="seat";e.textContent=v.toString().padStart(2,"0")}return e;}
let sel=null,bl=[],rb=[],rbSet=new Set(),userBlockedSeats=[],fakeBlockedSeats=[],currentUserCPF=null,currentCurso="",currentBus="",layout=[];

const GET="YOUR_POWER_AUTOMATE_GET_URL";
const POST="YOUR_POWER_AUTOMATE_POST_URL";
const map={AAL:"0046",ALI:"0046",QUI:"0046"};

const fetchJSON=async u=>{
  const c=new AbortController(),id=setTimeout(()=>c.abort(),5000);
  try{return await(await fetch(u+"?v="+Date.now(),{signal:c.signal})).json()}
  finally{clearTimeout(id)}
};

const render=l=>{
  const w=q("#busContainer");w.querySelector(".grid")?.remove();
  const g=document.createElement("div");g.className="grid";
  const frag=document.createDocumentFragment();
  for(const row of l)for(const v of row){
    const e=cSeat(v);
    if(v!==null&&v!=="white"){
      const id=v.toString().padStart(2,"0");
      e.dataset.seat=id;
      if(bl.includes(id)||userBlockedSeats.includes(id)||fakeBlockedSeats.includes(id)||rbSet.has(id))e.classList.add("white");
      else e.onclick=()=>{if(e.classList.contains("white")||e.classList.contains("lost"))return; sel?.classList.remove("selected"); sel=e!==sel?(e.classList.add("selected"),e):null;}
    }
    frag.appendChild(e);
  }
  g.appendChild(frag);w.appendChild(g);
  
  // Posiciona cursoBox e confirmarBtn fora do container
  const containerRect=w.getBoundingClientRect();
  const cursoBox=q("#cursoBox");
  cursoBox.style.top=containerRect.top + "px";
  cursoBox.style.left=containerRect.right + "px";

  const confirmarBtn=q("#confirmarBtn");
  confirmarBtn.style.top=containerRect.bottom + 20 + "px";
  confirmarBtn.style.left=containerRect.right - confirmarBtn.offsetWidth + "px";
};

// Exemplo de layout (substituir pelo fetch real)
layout = [
  [1,2,3,4,5],
  [6,7,8,9,10],
  [11,12,13,14,15],
];
render(layout);
q("#cursoText").textContent = "AAL";

// Botão confirmar
q("#confirmarBtn").onclick=()=>{
  if(!sel){alert("Selecione uma poltrona."); return;}
  alert("Poltrona selecionada: "+sel.textContent);
};
</script>
</body>
</html>
