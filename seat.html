<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner</title>
<style>
*{box-sizing:border-box;}
body{margin:0;font-family:Arial,sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column;background:#fff;}
/* Splash */
#splash{position:fixed;inset:0;z-index:9;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#fff;}
#splash b{font-size:36px;color:#4CAF50;margin-bottom:10px;}
#splash i{width:120px;height:2px;background:#e0e0e0;overflow:hidden;}
#splash i:after{content:"";display:block;width:40px;height:100%;background:#4CAF50;animation:l .9s infinite;}
@keyframes l{from{transform:translateX(-40px);}to{transform:translateX(120px);}}

/* App login */
.app{width:90%;max-width:300px;visibility:hidden;}
label{font-size:16px;color:#333;margin:0 0 6px 2px;}
.row{display:flex;align-items:center;gap:8px;border-bottom:1px solid #ccc;}
.row:focus-within{border-color:#ccc;}
.row.err{border-color:#e53935;}
.row.ok{border-color:#4CAF50;}
input{flex:1 1 auto;min-width:0;border:0;padding:10px 2px;font-size:18px;background:0;outline:0;}
input::placeholder{font-size:16px;color:#999;}
button{flex:0 0 auto;max-width:35%;padding:6px 12px;border:1px solid #aaa;border-radius:20px;background:0;color:#aaa;font-size:14px;font-weight:bold;white-space:nowrap;}
button.ready{background:#4CAF50;color:#fff;border-color:#4CAF50;cursor:pointer;}
button.ready:active{transform:scale(.97);}
.errmsg{font-size:13px;color:#e53935;margin:14px 0 0 2px;display:none;}

/* Layout de poltronas */
#bus-wrapper{transform:scale(.8);transform-origin:top center;display:none;width:100%;flex-direction:column;align-items:center;margin-top:20px;position:relative;}
.bus-container{padding:20px;border:3px solid #b0b0b0;border-radius:16px;display:flex;flex-direction:column;align-items:center;position:relative;}
#cursoBox{position:absolute;top:60px;left:100%;width:40px;height:122px;background:#4CAF50;color:#fff;font-weight:bold;display:flex;align-items:center;justify-content:center;overflow:hidden;z-index:9999;}
#cursoText{transform:rotate(-90deg);font-size:18px;white-space:nowrap;}
.grid{display:grid;gap:14px 10px;justify-items:center;}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative;}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer;}
.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2;}
.seat.white{background:#fff!important;border:3px solid #8c96b2!important;color:transparent!important;cursor:default!important;pointer-events:none!important;}
.seat.white::after{border-color:#8c96b2!important;}
.seat.selected{background:#e74c3c;border-color:#e74c3c;}
.seat.lost{background:#b0b0b0!important;border-color:#b0b0b0!important;color:transparent!important;pointer-events:none!important;}
.seat.lost::before{content:"✖";color:#fff;font-size:28px;font-weight:bold;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);}
.empty{background:0 0;}
#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:#0001;z-index:9999;}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .1s linear;}
#confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;margin-top:20px;}
</style>
</head>
<body>
<div id="splash"><b>Planner</b><i></i></div>

<!-- Login -->
<div class="app">
  <label>CPF</label>
  <div class="row">
    <input id="cpf" placeholder="CPF (somente números)" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
    <button id="btn" disabled>ENTRAR</button>
  </div>
  <div class="errmsg" id="err"></div>
</div>

<!-- Layout de assentos -->
<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText">AAL</div></div>
    <div id="seats-grid" class="grid"></div>
    <button id="confirmarBtn">CONFIRMAR</button>
  </div>
</div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
// Splash
setTimeout(()=>{splash.remove();document.querySelector(".app").style.visibility="visible"},1600);

const $=s=>document.querySelector(s);
const cpf=$("#cpf"),btn=$("#btn"),err=$("#err");
let currentCurso="AAL",currentBus="0046",layout=[],bl=[],fakeBlockedSeats=[],selected=null;

// Map de turma -> JSON
const map={AAL:"0046",ALI:"0046",QUI:"0046"};
const GET="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";

// Validação CPF + consulta Power Automate
cpf.oninput=()=>{
  const val=cpf.value.replace(/\D/g,"");
  cpf.value=val;
  btn.disabled=true; err.style.display="none";
  if(val.length===11){
    fetch(GET,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({cpf:val})
    }).then(r=>r.json()).then(d=>{
      const autorizado=(d.codigo||[]).find(x=>x.CPF2===val||x.CPF===val);
      if(autorizado){
        currentCurso=autorizado.CODIGO.toUpperCase()||"AAL";
        currentBus=map[currentCurso]||"0046";
        $("#cursoText").textContent=currentCurso;
        btn.disabled=false; btn.classList.add("ready");
      } else { err.textContent="CPF não autorizado"; err.style.display="block"; btn.disabled=true; }
    }).catch(()=>{ err.textContent="Erro de comunicação"; err.style.display="block"; });
  }
};

// Ao clicar em entrar
btn.onclick=()=>{
  if(btn.disabled) return;
  sessionStorage.setItem("cpf",cpf.value);
  sessionStorage.setItem("curso",currentCurso);
  document.querySelector(".app").style.display="none";
  $("#bus-wrapper").style.display="flex";
  document.documentElement.requestFullscreen().catch(()=>{});
  loadSeats();
};

// Barra de progresso animada
function animProgress(t){
  let w=parseFloat($("#progress-bar").style.width)||0;
  (function s(){if(w<t){w++;$("#progress-bar").style.width=w+"%";requestAnimationFrame(s)}})();
}

// Carregar layout
async function loadSeats(){
  animProgress(20);
  try{
    const res = await fetch(`configs/${currentBus}.json`);
    const data = await res.json();
    layout = data.layout;
    animProgress(50);
    bl = []; // poltronas já reservadas / perdidas podem ser definidas aqui
    fakeBlockedSeats = []; // se quiser fake blocking
    const grid=$("#seats-grid");
    grid.style.gridTemplateColumns=`repeat(${layout[0].length},54px)`;
    grid.innerHTML="";
    layout.forEach(row=>{
      row.forEach(cell=>{
        const div=document.createElement("div");
        if(cell===null) div.className="empty";
        else if(cell==="white") div.className="seat white";
        else{
          div.className="seat";
          div.textContent=cell.toString().padStart(2,"0");
          if(bl.includes(cell.toString().padStart(2,"0")) || fakeBlockedSeats.includes(cell.toString().padStart(2,"0")))
            div.classList.add("white");
          else div.onclick=()=>selectSeat(div);
        }
        grid.appendChild(div);
      });
    });
    animProgress(100);
    setTimeout(()=>$("#progress-bar-container").remove(),600);
  }catch(e){alert("Erro ao carregar layout");}
}

// Seleção única
function selectSeat(el){
  if(el.classList.contains("white")) return;
  if(selected) selected.classList.remove("selected");
  if(selected===el){ selected=null; return; }
  el.classList.add("selected");
  selected=el;
}
</script>
</body>
</html>
