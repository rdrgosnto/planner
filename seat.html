<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner</title>
<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#fff;display:flex;flex-direction:column;align-items:center;min-height:100vh;}
#splash{position:fixed;inset:0;z-index:9;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#fff}
#splash b{font-size:36px;color:#4CAF50;margin-bottom:10px}
#splash i{width:120px;height:2px;background:#e0e0e0;overflow:hidden}
#splash i:after{content:"";display:block;width:40px;height:100%;background:#4CAF50;animation:l .9s infinite}
@keyframes l{from{transform:translateX(-40px)}to{transform:translateX(120px)}}

.app{width:90%;max-width:300px;visibility:hidden;display:flex;flex-direction:column;justify-content:center;align-items:center;flex:1;}
label{font-size:16px;color:#333;margin:0 0 6px 2px}
.row{display:flex;align-items:center;gap:8px;border-bottom:1px solid #ccc;width:100%}
.row:focus-within{border-color:#ccc}
.row.err{border-color:#e53935}
.row.ok{border-color:#4CAF50}
input{flex:1 1 auto;min-width:0;border:0;padding:10px 2px;font-size:18px;background:0;outline:0}
input::placeholder{font-size:16px;color:#999}
button{flex:0 0 auto;max-width:35%;padding:6px 12px;border:1px solid #aaa;border-radius:20px;background:0;color:#aaa;font-size:14px;font-weight:bold;white-space:nowrap}
button.ready{background:#4CAF50;color:#fff;border-color:#4CAF50;cursor:pointer}
button.ready:active{transform:scale(.97)}
.errmsg{font-size:13px;color:#e53935;margin:14px 0 0 2px;display:none}

/* Layout de poltronas */
#bus-wrapper{display:none;flex-direction:column;align-items:center;margin-top:40px;transform:scale(.8);transform-origin:top center;}
.bus-container{padding:20px;border:3px solid #b0b0b0;border-radius:16px;display:flex;flex-direction:column;align-items:center;position:relative}
#cursoBox{position:absolute;top:0;right:-60px;width:40px;height:122px;background:#4CAF50;color:#fff;font-weight:bold;display:flex;align-items:center;justify-content:center;overflow:hidden;pointer-events:none;z-index:9999}
#cursoText{transform:rotate(-90deg);font-size:18px;white-space:nowrap}
.grid{display:grid;gap:14px 10px;justify-items:center}
.seat,.empty{width:54px;height:54px;display:flex;align-items:center;justify-content:center;border-radius:12px;position:relative}
.seat{background:#4CAF50;border:3px solid #4CAF50;color:#fff;font-weight:bold;cursor:pointer}
.seat::after{content:"";position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:32px;height:14px;border-radius:8px;background:#fff;border:3px solid #8c96b2}
.seat.white{background:#fff!important;border:3px solid #8c96b2!important;color:transparent!important;cursor:default!important;pointer-events:none!important}
.seat.white::after{border-color:#8c96b2!important}
.seat.selected{background:#e74c3c;border-color:#e74c3c}
.empty{background:0 0}
.seat.lost{background:#b0b0b0!important;border-color:#b0b0b0!important;color:transparent!important;pointer-events:none!important}
.seat.lost::before{content:"✖";color:#fff;font-size:28px;font-weight:bold;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}

#confirmarBtn{width:112px;height:54px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:12px;cursor:pointer;margin-top:20px;align-self:flex-end}
#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:#0001;z-index:9999}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .1s linear}
</style>
</head>
<body>
<div id="splash"><b>Planner</b><i></i></div>

<div class="app">
  <label>CPF</label>
  <div class="row">
    <input id="cpf" placeholder="CPF (somente números)" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
    <button id="btn" disabled>ENTRAR</button>
  </div>
  <div class="errmsg" id="err"></div>
</div>

<div id="bus-wrapper">
  <div class="bus-container">
    <div id="cursoBox"><div id="cursoText"></div></div>
    <div id="seats-grid" class="grid"></div>
  </div>
  <button id="confirmarBtn">CONFIRMAR</button>
</div>

<div id="progress-bar-container"><div id="progress-bar"></div></div>

<script>
setTimeout(()=>{splash.remove();document.querySelector(".app").style.visibility="visible"},1600);

const $ = s => document.querySelector(s);
const cpf = $("#cpf"), btn = $("#btn"), err = $("#err"), row = $(".row");
const normCPF = v => v.replace(/\D/g,"").padStart(11,"0");
const DEBOUNCE = 400; 
let timer = null;

function cpfValido(c){
  if(/^(\d)\1+$/.test(c)) return false;
  let t9=0, t10=0;
  for(let i=0;i<9;i++) t9+=c[i]*(10-i);
  for(let i=0;i<10;i++) t10+=c[i]*(11-i);
  const d1=((t9*10)%11)%10;
  const d2=((t10*10)%11)%10;
  return d1==c[9] && d2==c[10];
}

cpf.oninput = () => {
  const val = cpf.value.replace(/\D/g,"");
  cpf.value = val;
  btn.disabled = true;
  row.className="row"; err.style.display="none";

  if(timer) clearTimeout(timer);
  if(val.length === 0) return;

  if(val.length < 11 || !cpfValido(val.padStart(11,'0'))){
    err.textContent = "CPF inválido";
    err.style.display = "block";
    row.classList.add("err");
    return;
  }

  timer = setTimeout(async () => {
    try{
      const r = await fetch("https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA",
        {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf:normCPF(val)})});
      const d = await r.json();
      const autorizado = (d.codigo||[]).find(x => normCPF(x.CPF2||x.CPF) === normCPF(val));
      if(!autorizado) throw 0;

      btn.disabled = false;
      btn.classList.add("ready");
      row.classList.add("ok");
    } catch {
      err.textContent = "CPF não autorizado";
      err.style.display = "block";
      row.classList.add("err");
      btn.disabled = true;
    }
  }, DEBOUNCE);
};

btn.onclick = () => {
  if(btn.disabled) return;
  sessionStorage.setItem("cpf", normCPF(cpf.value));
  sessionStorage.setItem("authMapa",1);
  document.querySelector(".app").style.display="none";
  $("#bus-wrapper").style.display="flex";
  document.documentElement.requestFullscreen().catch(()=>{});
  loadSeats();
};

const map = {AAL:"0046", ALI:"0046", QUI:"0046"};
let selected = null;

async function loadSeats(){
  const grid = $("#seats-grid");
  try{
    const cpfStored = sessionStorage.getItem("cpf");
    if(!cpfStored) return;
    const r = await fetch("https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA",
      {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cpf:cpfStored})});
    const data = await r.json();
    const aluno = (data.codigo||[]).find(x=>normCPF(x.CPF2||x.CPF)===cpfStored);
    const turma = aluno? aluno.CODIGO.toUpperCase() : "AAL";
    $("#cursoText").textContent = turma;
    const busFile = map[turma] || "0046";
    const cfg = await (await fetch(`configs/${busFile}.json`)).json();
    const layout = cfg.layout;
    grid.style.gridTemplateColumns = `repeat(${layout[0].length}, 54px)`;
    grid.innerHTML = "";
    layout.forEach(row=>{
      row.forEach(cell=>{
        const div = document.createElement("div");
        if(cell===null) div.className="empty";
        else if(cell==="white") div.className="seat white";
        else {
          div.className="seat";
          div.textContent = cell.toString().padStart(2,'0');
          div.onclick = ()=>selectSeat(div);
        }
        grid.appendChild(div);
      });
    });
  } catch(e){ alert("Erro ao carregar layout de assentos."); }
}

function selectSeat(el){
  if(el.classList.contains("white")) return;
  if(selected) selected.classList.remove("selected");
  if(selected===el){ selected=null; return; }
  el.classList.add("selected");
  selected=el;
}
</script>
</body>
</html>
