<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pina | Ingresso</title>

<style>
* { box-sizing:border-box; margin:0; padding:0; }

html, body {
    width:100%;
    height:100%;
    background:#000;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    color:#fff;
    overflow:hidden;

    /* ‚ùå impedir sele√ß√£o de texto */
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
}

/* ===== V√çDEO ===== */
#videoFundo {
    position:absolute;
    top:50%;
    left:50%;
    width:100%;
    height:100%;
    transform:translate(-50%,-50%);
    object-fit:contain;
    background:#000;
    z-index:0;
    transition:filter .9s ease;
}

#videoFundo.pausado {
    filter:brightness(.55);
}

/* overlay cinematogr√°fico */
.cinema-overlay {
    position:absolute;
    inset:0;
    background:linear-gradient(
        to bottom,
        rgba(0,0,0,.55),
        rgba(0,0,0,.2),
        rgba(0,0,0,.6)
    );
    z-index:1;
}

/* conte√∫do */
.overlay {
    position:absolute;
    inset:0;
    z-index:2;
}

/* ===== CPF GROUP ===== */
.cpf-group {
    position:absolute;
    bottom:clamp(30px,6vh,80px);
    left:50%;
    transform:translateX(-50%);
    width:90%;
    max-width:400px;
    display:flex;
    flex-direction:column;
    gap:10px;
}

.label-cpf { font-size:14px; }

.status {
    min-height:18px;
    font-size:14px;
}

/* ===== CAIXA CPF ===== */
.cpf-field {
    height:48px;
    border-radius:0;
    border:1px solid rgba(255,255,255,.25);
    background:rgba(0,0,0,.45);
    display:flex;
    align-items:center;
    padding:0 12px;
    backdrop-filter:blur(4px);
}

.cpf-field input {
    width:100%;
    border:none;
    outline:none;
    background:transparent;
    color:#fff;
    font-size:15px;
    line-height:48px;
    padding:0;

    /* input continua selecion√°vel */
    -webkit-user-select: text;
    user-select: text;
}

.cpf-field input::placeholder {
    font-size:12px;
    color:#cfcfcf;
}

/* bot√£o */
.btn-primary {
    display:none;
    height:48px;
    border:none;
    border-radius:0;
    background:#fff;
    color:#000;
    font-size:15px;
    font-weight:500;
    cursor:pointer;
}

.btn-primary:hover {
    background:#eaeaea;
}
</style>
</head>
<body>

<video id="videoFundo" autoplay muted playsinline loop>
    <source src="pina_.mp4" type="video/mp4">
</video>

<div class="cinema-overlay"></div>

<div class="overlay">
    <div class="cpf-group">

        <div class="label-cpf">CPF (somente n√∫meros)</div>

        <div class="cpf-field">
            <input id="cpfInput" inputmode="numeric" placeholder="CPF (somente n√∫meros)" autocomplete="off">
        </div>

        <div class="status" id="statusMsg"></div>

        <button class="btn-primary" id="btnDownload">Baixar ingresso</button>

    </div>
</div>

<script>
const cpfInput    = document.getElementById("cpfInput");
const btnDownload = document.getElementById("btnDownload");
const statusMsg   = document.getElementById("statusMsg");
const video       = document.getElementById("videoFundo");

/* üé¨ velocidade do v√≠deo */
video.playbackRate = 1.00;

let debounce;

/* ===== HAPTIC ===== */
function vibrarErro(){
    if(navigator.vibrate){
        navigator.vibrate(30);
    }
}

/* ===== CONTROLE DE V√çDEO ===== */
function pausarVideoSuave(){
    video.classList.add("pausado");
    setTimeout(() => {
        if(!video.paused) video.pause();
    }, 450);
}

function tocarVideoSuave(){
    video.play().catch(()=>{});
    video.classList.remove("pausado");
}

/* ===== PRESS & HOLD (250ms) ===== */
let holdTimer = null;
let emHold = false;
const HOLD_TIME = 250;

function iniciarHold(){
    if(holdTimer) return;

    holdTimer = setTimeout(() => {
        emHold = true;
        pausarVideoSuave();
    }, HOLD_TIME);
}

function cancelarHold(){
    clearTimeout(holdTimer);
    holdTimer = null;

    if(emHold){
        emHold = false;
        tocarVideoSuave();
    }
}

/* mobile */
document.addEventListener("touchstart", iniciarHold, { passive:true });
document.addEventListener("touchend", cancelarHold);
document.addEventListener("touchcancel", cancelarHold);

/* desktop */
document.addEventListener("mousedown", iniciarHold);
document.addEventListener("mouseup", cancelarHold);
document.addEventListener("mouseleave", cancelarHold);

/* CPF utils */
const norm = v => v.replace(/\D/g,"").padStart(11,"0");
const valido = c => {
    if(/^(\d)\1+$/.test(c)) return false;
    for(let t=9;t<11;t++){
        let s=0;
        for(let i=0;i<t;i++) s+=c[i]*(t+1-i);
        if(((s*10)%11)%10!=c[t]) return false;
    }
    return true;
};

/* Power Automate */
async function buscarIngresso(cpf){
    const r = await fetch(
        "https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/8a482c5f6dd04dd3b167d97ea0a07307/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=kWvGjXp0sqrlB9TuVb02vSAeLqwEjTU0-dU9J0HqkFE",
        {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({ cpf })
        }
    );
    const d = await r.json();
    return (d.codigo||[]).find(x => norm(x.CPF2||"") === cpf && x.GOOGLE);
}

/* input */
cpfInput.oninput = () => {
    cpfInput.value = cpfInput.value.replace(/\D/g,"");
    pausarVideoSuave();
    btnDownload.style.display="none";
    statusMsg.textContent="";
    clearTimeout(debounce);

    if(cpfInput.value.length < 11){
        statusMsg.textContent="CPF inv√°lido";
        vibrarErro();
        return;
    }

    cpfInput.blur();
    debounce = setTimeout(() => validarCPF(norm(cpfInput.value)), 400);
};

async function validarCPF(cpf){
    if(!valido(cpf)){
        statusMsg.textContent="CPF inv√°lido";
        vibrarErro();
        pausarVideoSuave();
        return;
    }

    tocarVideoSuave();

    try{
        const autorizado = await buscarIngresso(cpf);
        if(!autorizado) throw 0;

        statusMsg.textContent="CPF localizado";
        pausarVideoSuave();
        btnDownload.style.display="block";

        const id = autorizado.GOOGLE;
        btnDownload.onclick = () => {
            tocarVideoSuave();
            const a = document.createElement("a");
            a.href = `https://drive.google.com/uc?export=download&id=${id}`;
            a.download = "ingresso.png";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

    } catch {
        statusMsg.textContent="CPF n√£o autorizado";
        vibrarErro();
        pausarVideoSuave();
        btnDownload.style.display="none";
    }
}
</script>

</body>
</html>
