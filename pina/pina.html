<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pina | Ingresso</title>

<style>
*{ box-sizing:border-box; }

html,body{
  margin:0;
  min-height:100%;
  background:#121212;
  color:#f1f1f1;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
}

body{
  display:flex;
  justify-content:center;
  padding:0;
}

.app{
  width:100%;
  max-width:420px;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
}

/* ===== CARD ===== */
.card{
  background:#1c1c1c;
  border-radius:14px;
  padding:18px;
  border:1px solid rgba(255,255,255,.06);
  box-shadow:0 8px 24px rgba(0,0,0,.4);
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  min-height:100vh;
  position:relative;
}

/* ===== LOGO ===== */
.logo{
  position:absolute;
  top:24px;
  left:50%;
  transform:translateX(-50%);
  z-index:2;
}
.logo img{
  height:44px;
  display:block;
  filter:invert(1) brightness(1.1);
}

/* ===== INGRESSO ===== */
.ingresso{
  position:relative;
  margin-top:80px; /* espaço para logo */
  margin-bottom:16px;
}

.ingresso img{
  width:100%;
  display:block;
  border-radius:10px;
}

/* ===== LOADING IMAGEM ===== */
.loading-img{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:10px;
  font-size:14px;
  color:#cfcfcf;
  opacity:0;
  pointer-events:none;
  transition:opacity .2s ease;
}
.loading-img.ativo{
  opacity:1;
}

/* ===== TEXTO FIXO ===== */
.texto{
  font-size:14px;
  color:#cfcfcf;
  margin-bottom:10px;
  padding-left:3px; /* 2px deslocamento refinado */
}

/* ===== CPF ===== */
.cpf-field{
  position:relative;
  height:42px;
  width:100%;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.15);
  background:#151515;
  display:flex;
  align-items:center;
  padding:0 12px;
  cursor:text;
}
.cpf-field:focus-within{
  border-color:#ffffff;
}
#cpfVisual{
  font-size:15px;
  color:#9a9a9a;
  white-space:nowrap;
  padding-left:2px; /* refinamento */
}
#cpfInput{
  position:absolute;
  inset:0;
  opacity:0;
  border:none;
  outline:none;
  background:transparent;
}

/* ===== STATUS ===== */
.status{
  margin-top:8px;
  font-size:14px;
  min-height:18px;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  padding-left:3px; /* 2px deslocamento refinado */
  border-radius:6px;
  color:#fff;
}

/* ===== BOTÃO ===== */
.btn-primary{
  margin-top:12px;
  width:100%;
  height:42px;
  border:none;
  border-radius:8px;
  background:#ffffff;
  color:#000;
  font-size:15px;
  font-weight:500;
  cursor:pointer;
  display:none;
}
.btn-primary:hover{
  background:#eaeaea;
}
</style>
</head>

<body>

<main class="app">

  <section class="card">

    <!-- LOGO -->
    <div class="logo">
      <img src="pina_.png" alt="Pina">
    </div>

    <!-- INGRESSO -->
    <div class="ingresso">
      <img id="imgIngresso"
           src="https://drive.google.com/thumbnail?id=1-KRVOHrwUy83uttLnP8JVvJmnbmROnVe&sz=w1200">
      <div class="loading-img" id="loadingImg">
        Carregando ingresso…
      </div>
    </div>

    <!-- TEXTO FIXO -->
    <div class="texto">
      CPF (somente números)
    </div>

    <!-- CPF -->
    <div class="cpf-field" id="boxCPF" tabindex="0">
      <span id="cpfVisual">Digite aqui</span>
      <input
        id="cpfInput"
        inputmode="numeric"
        enterkeyhint="done"
        autocomplete="off">
    </div>

    <!-- STATUS -->
    <div class="status" id="statusMsg">CPF inválido</div>

    <!-- BOTÃO -->
    <button class="btn-primary" id="btnDownload">
      Baixar ingresso
    </button>

  </section>

</main>

<script>
const boxCPF=document.getElementById("boxCPF");
const cpfInput=document.getElementById("cpfInput");
const cpfVisual=document.getElementById("cpfVisual");
const btnDownload=document.getElementById("btnDownload");
const imgIngresso=document.getElementById("imgIngresso");
const statusMsg=document.getElementById("statusMsg");
const loadingImg=document.getElementById("loadingImg");

let debounce;

const norm=v=>v.replace(/\D/g,"").padStart(11,"0");

const valido=c=>{
  if(/^(\d)\1+$/.test(c)) return false;
  for(let t=9;t<11;t++){
    let s=0;
    for(let i=0;i<t;i++) s+=c[i]*(t+1-i);
    if(((s*10)%11)%10!=c[t]) return false;
  }
  return true;
};

function esconderTeclado(){
  cpfInput.blur();
}

async function buscarIngresso(cpf){
  // Mantenha sua API do Power Automate
  const r=await fetch(
    "SUA_API_AQUI",
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({cpf})
    }
  );
  const d=await r.json();
  return (d.codigo||[]).find(x =>
    norm(x.CPF2||"")===cpf &&
    x.GOOGLE
  );
}

cpfInput.oninput=()=>{
  cpfInput.value=cpfInput.value.replace(/\D/g,"");
  cpfVisual.textContent=cpfInput.value||"Digite aqui";
  cpfVisual.style.color=cpfInput.value?"#fff":"#9a9a9a";
  btnDownload.style.display="none";

  if(cpfInput.value.length<11){
    statusMsg.textContent="CPF inválido";
    statusMsg.style.color="#fff";
    return;
  }

  clearTimeout(debounce);
  debounce=setTimeout(()=>validarCPF(norm(cpfInput.value)),400);
};

async function validarCPF(cpf){
  if(cpf.length!==11) return;

  if(!valido(cpf)){
    statusMsg.textContent="CPF inválido";
    statusMsg.style.color="#fff";
    return;
  }

  // Carregando...
  statusMsg.textContent="Carregando";
  statusMsg.style.color="#000";
  let dots=0;
  const intervalDots=setInterval(()=>{
    dots++;
    statusMsg.textContent="Carregando" + ".".repeat(dots%4);
  },400);

  loadingImg.classList.add("ativo");

  try{
    const autorizado=await buscarIngresso(cpf);
    if(!autorizado) throw 0;

    const id=autorizado.GOOGLE;
    imgIngresso.onload=()=>loadingImg.classList.remove("ativo");
    imgIngresso.src=`https://drive.google.com/thumbnail?id=${id}&sz=w1200`;

    // CPF localizado
    statusMsg.textContent="CPF localizado";
    statusMsg.style.color="#fff";

    setTimeout(()=>{
      clearInterval(intervalDots);
      loadingImg.classList.remove("ativo");
      btnDownload.style.display="block";
      btnDownload.onclick=()=>download(
        `https://drive.google.com/uc?export=download&id=${id}`
      );
    },600);

  }catch{
    clearInterval(intervalDots);
    loadingImg.classList.remove("ativo");
    statusMsg.textContent="CPF não autorizado";
    statusMsg.style.color="#fff";
  }
}

function download(url){
  const a=document.createElement("a");
  a.href=url;
  a.download="ingresso.png";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
</script>

</body>
</html>
