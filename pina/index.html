<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pina | Ingresso</title>

<style>
html, body {
  margin:0; padding:0;
  height:100%; width:100%;
  background:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  font-family:Arial,sans-serif;
}

#containerIngresso {
  width:90%;
  max-width:400px;
  margin-top:60px;
  position:relative;
}

#containerIngresso img {
  width:100%;
  position:absolute;
  top:0; left:0;
  transition:opacity 1s ease-in-out;
}

#btnCPF, #btnDownload {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:400px;
  height:36px;
  line-height:36px;
  background:#000;
  color:#fff;
  font-size:16px;
  font-weight:bold;
  border:none;
  cursor:pointer;
  text-align:center;
}

#btnCPF input {
  width:100%;
  height:36px;
  background:#000;
  color:#fff;
  border:none;
  outline:none;
  font-size:16px;
  font-weight:bold;
  text-align:center;
}

#btnDownload { display:none; }

.cursor::after {
  content:"|";
  animation:blink 1s step-start infinite;
}

@keyframes blink {
  0%,50%{opacity:1}
  50.01%,100%{opacity:0}
}
</style>
</head>

<body>

<div id="containerIngresso">
  <img id="imgIngresso"
       src="https://drive.google.com/thumbnail?id=1-KRVOHrwUy83uttLnP8JVvJmnbmROnVe&sz=w1200"
       style="opacity:1;z-index:1">
</div>

<button id="btnCPF">CPF (somente números)</button>
<button id="btnDownload">Baixar ingresso</button>

<script>
const btnCPF = document.getElementById("btnCPF");
const btnDownload = document.getElementById("btnDownload");
const imgIngresso = document.getElementById("imgIngresso");
const container = document.getElementById("containerIngresso");

let estado = "inicial";
let debounce;

/* ========= FUNÇÕES BASE ========= */
const norm = v => v.replace(/\D/g,"").padStart(11,"0");

const valido = c => {
  if(/^(\d)\1+$/.test(c)) return 0;
  for(let t=9;t<11;t++){
    let s=0;
    for(let i=0;i<t;i++) s+=c[i]*(t+1-i);
    if(((s*10)%11)%10!=c[t]) return 0;
  }
  return 1;
};

/* ========= CONSULTA POWER AUTOMATE ========= */
async function buscarIngresso(cpf){
  const r = await fetch(
    "https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/8a482c5f6dd04dd3b167d97ea0a07307/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=kWvGjXp0sqrlB9TuVb02vSAeLqwEjTU0-dU9J0HqkFE",
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ cpf })
    }
  );

  const d = await r.json();

  return (d.codigo||[]).find(x =>
    norm(x.CPF2||"") === cpf &&
    String(x.ID).trim() === "#" &&
    x.GOOGLE
  );
}

/* ========= INTERAÇÃO ========= */
btnCPF.onclick = () => {
  if(estado==="inicial"||estado==="invalido"){
    btnCPF.innerHTML =
      '<input id="cpfInput" class="cursor" placeholder="CPF (somente números)">';
    const input = document.getElementById("cpfInput");
    input.focus();
    estado="digitando";

    input.oninput = () => {
      input.value = input.value.replace(/\D/g,"");
      if(input.value.length===11){
        clearTimeout(debounce);
        debounce = setTimeout(
          ()=>validarCPF(norm(input.value)),400
        );
      }
    };
  }
};

/* ========= VALIDAÇÃO ========= */
async function validarCPF(cpf){
  if(!valido(cpf)){
    btnCPF.innerText="CPF inválido";
    estado="invalido";
    return;
  }

  estado="carregando";
  let dots=0;
  const anim=setInterval(()=>{
    if(estado!=="carregando"){clearInterval(anim);return;}
    btnCPF.innerText="carregando"+".".repeat(dots++%4);
  },500);

  try{
    const autorizado = await buscarIngresso(cpf);
    clearInterval(anim);

    if(!autorizado) throw 0;

    estado="valido";

    const id = autorizado.GOOGLE;
    const imgUrl = `https://drive.google.com/thumbnail?id=${id}&sz=w1200`;
    const downUrl = `https://drive.google.com/uc?export=download&id=${id}`;

    const temp = new Image();
    temp.src = imgUrl;
    temp.style.opacity=0;
    temp.style.position="absolute";
    temp.style.zIndex=2;
    temp.style.transition="opacity 1s";
    container.appendChild(temp);

    setTimeout(()=>temp.style.opacity=1,50);
    setTimeout(()=>{
      imgIngresso.style.opacity=0;
      setTimeout(()=>{
        imgIngresso.src=imgUrl;
        imgIngresso.style.opacity=1;
        temp.remove();
        btnCPF.style.display="none";
        btnDownload.style.display="block";
        btnDownload.onclick=()=>download(downUrl);
      },1000);
    },1050);

  }catch{
    clearInterval(anim);
    btnCPF.innerText="CPF não autorizado";
    estado="invalido";
  }
}

/* ========= DOWNLOAD ========= */
function download(url){
  const a=document.createElement("a");
  a.href=url;
  a.download="ingresso.png";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
</script>

</body>
</html>
