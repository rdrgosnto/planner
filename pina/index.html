<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pina | Ingresso</title>

<style>
html, body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  font-family:Arial,sans-serif;
  position:fixed; /* evita scroll iOS */
}

/* ===== IMAGEM ===== */
#containerIngresso{
  width:90%;
  max-width:400px;
  margin-top:60px;
  position:relative;
}

#containerIngresso img{
  width:100%;
  position:absolute;
  top:0;
  left:0;
}

/* ===== CAIXA CPF (FIXA) ===== */
#boxCPF{
  position:fixed;
  bottom:calc(20px + env(safe-area-inset-bottom));
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:400px;
  height:36px;
  background:#000;
  color:#fff;
  font-size:15px;        /* um pouco menor */
  font-weight:500;       /* menos negrito */
  display:flex;
  align-items:center;
  justify-content:center;
  box-sizing:border-box;
  touch-action:manipulation;
}

/* texto visível */
#cpfVisual{
  pointer-events:none;
  white-space:nowrap;
  color:#999;
}

/* input invisível */
#cpfInput{
  position:absolute;
  inset:0;
  opacity:0;
  border:none;
  outline:none;
  background:transparent;
  color:transparent;
  font-size:16px; /* evita zoom iOS */
}

/* ===== BOTÃO DOWNLOAD ===== */
#btnDownload{
  position:fixed;
  bottom:calc(20px + env(safe-area-inset-bottom));
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:400px;
  height:36px;
  background:#000;
  color:#fff;
  font-size:15px;
  font-weight:500;
  border:none;
  cursor:pointer;
  display:none;
}
</style>
</head>

<body>

<div id="containerIngresso">
  <img id="imgIngresso"
       src="https://drive.google.com/thumbnail?id=1-KRVOHrwUy83uttLnP8JVvJmnbmROnVe&sz=w1200">
</div>

<div id="boxCPF">
  <span id="cpfVisual">CPF (somente números)</span>
  <input id="cpfInput"
         inputmode="numeric"
         pattern="[0-9]*"
         autocomplete="off">
</div>

<button id="btnDownload">Baixar ingresso</button>

<script>
const boxCPF     = document.getElementById("boxCPF");
const cpfInput   = document.getElementById("cpfInput");
const cpfVisual  = document.getElementById("cpfVisual");
const btnDownload= document.getElementById("btnDownload");
const imgIngresso= document.getElementById("imgIngresso");

let estado = "inicial";
let debounce;
let locked = false;

/* ===== HELPERS ===== */
const norm = v => v.replace(/\D/g,"").padStart(11,"0");

const valido = c => {
  if(/^(\d)\1+$/.test(c)) return false;
  for(let t=9;t<11;t++){
    let s=0;
    for(let i=0;i<t;i++) s+=c[i]*(t+1-i);
    if(((s*10)%11)%10!=c[t]) return false;
  }
  return true;
};

/* ===== POWER AUTOMATE ===== */
async function buscarIngresso(cpf){
  const r = await fetch(
    "https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/8a482c5f6dd04dd3b167d97ea0a07307/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=kWvGjXp0sqrlB9TuVb02vSAeLqwEjTU0-dU9J0HqkFE",
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ cpf })
    }
  );
  const d = await r.json();
  return (d.codigo||[]).find(x =>
    norm(x.CPF2||"") === cpf &&
    String(x.ID).trim() === "#" &&
    x.GOOGLE
  );
}

/* ===== INTERAÇÃO ===== */
boxCPF.addEventListener("pointerdown", () => {
  if(estado==="carregando") return;
  cpfInput.focus();
  cpfVisual.style.color="#999";
  estado="digitando";
});

cpfInput.addEventListener("paste", e => {
  e.preventDefault();
  cpfInput.value = e.clipboardData.getData("text").replace(/\D/g,"").slice(0,11);
  cpfInput.dispatchEvent(new Event("input"));
});

cpfInput.oninput = () => {
  cpfInput.value = cpfInput.value.replace(/\D/g,"");
  cpfVisual.textContent = cpfInput.value || "CPF (somente números)";
  cpfVisual.style.color = cpfInput.value ? "#fff" : "#999";

  if(cpfInput.value.length === 11){
    clearTimeout(debounce);
    debounce = setTimeout(() => validarCPF(norm(cpfInput.value)), 400);
  }
};

/* ===== VALIDAÇÃO ===== */
async function validarCPF(cpf){
  if(locked) return;
  locked = true;

  if(!valido(cpf)){
    cpfVisual.textContent = "CPF inválido";
    cpfVisual.style.color="#fff";
    estado="invalido";
    locked = false;
    return;
  }

  cpfVisual.textContent = "carregando...";
  cpfVisual.style.color="#fff";
  estado="carregando";

  try{
    const autorizado = await buscarIngresso(cpf);
    if(!autorizado) throw 0;

    const id = autorizado.GOOGLE;
    imgIngresso.src = `https://drive.google.com/thumbnail?id=${id}&sz=w1200`;

    setTimeout(()=>{
      boxCPF.style.display="none";
      btnDownload.style.display="block";
      btnDownload.onclick = () => download(
        `https://drive.google.com/uc?export=download&id=${id}`
      );
    },1000);

  }catch{
    cpfVisual.textContent = "CPF não autorizado";
    cpfVisual.style.color="#fff";
    estado="invalido";
    locked = false;
  }
}

/* ===== DOWNLOAD ===== */
function download(url){
  const a=document.createElement("a");
  a.href=url;
  a.download="ingresso.png";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
</script>

</body>
</html>
