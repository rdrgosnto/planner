<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planner | Início</title>
<style>
body{margin:0;padding:0;font-family:Arial,sans-serif;background:#fff;display:flex;justify-content:center;align-items:center;height:100vh;}
.container{width:90%;max-width:300px;}
label{display:block;font-size:16px;margin-bottom:10px;font-weight:bold;text-align:left;}
input{padding:12px;font-size:16px;border:2px solid #b0b0b0;border-radius:10px;width:100%;box-sizing:border-box;}
#entrarBtn{margin-top:10px;width:100px;height:45px;background:#4CAF50;color:#fff;border:none;font-size:16px;font-weight:bold;border-radius:10px;cursor:pointer;float:right;}
#entrarBtn:active{transform:scale(.97);}
#progress-bar-container{position:fixed;bottom:0;left:0;width:100%;height:8px;background:rgba(0,0,0,.1);display:none;}
#progress-bar{width:0;height:100%;background:#4CAF50;transition:width .15s linear;}
</style>
</head>
<body>
<div class="container">
  <label for="cpfInput">CPF</label>
  <input type="text" id="cpfInput" placeholder="CPF (somente números)">
  <button id="entrarBtn">ENTRAR</button>
</div>
<div id="progress-bar-container"><div id="progress-bar"></div></div>
<script>
const GET_ENDPOINT="https://default264c851fa4e743cf86bcd7b10dca85.78.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/239ef024d32946f99a66585bed86d236/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ItjHZInk4ZgqUycsWShgWkI1PEphNs_bQhmpReiFwuA";
const courseBusMap={AAL:"0046",ALI:"0046",QUI:"0046"};
const getFieldIgnoreCase=(o,...n)=>{for(const x of Object.keys(o||{})){const f=Object.keys(o).find(k=>k.toLowerCase()===x.toLowerCase());if(f)return o[f];}};
const fJSON=async u=>{try{const r=await fetch(u);return r.ok?await r.json():null;}catch{return null;}};

let fakeProgress=0,fakeInterval=null;
function startFakeProgress(){document.getElementById("progress-bar-container").style.display="block";fakeProgress=0;fakeInterval=setInterval(()=>{if(fakeProgress<90){fakeProgress+=Math.random()*3;document.getElementById("progress-bar").style.width=fakeProgress+"%";}},120);}
function finishProgress(){clearInterval(fakeInterval);const bar=document.getElementById("progress-bar");bar.style.transition="width .4s ease";bar.style.width="100%";}

function validarCPF(c){c=c.replace(/\D/g,"").padStart(11,"0");if(c.length!==11||/^(\d)\1+$/.test(c))return false;let s=0;for(let i=0;i<9;i++)s+=c[i]*(10-i);let r=(s*10)%11;if(r==10)r=0;if(r!=c[9])return false;s=0;for(let i=0;i<10;i++)s+=c[i]*(11-i);r=(s*10)%11;if(r==10)r=0;return r==c[10];}

document.getElementById("entrarBtn").onclick=async()=>{
  let cpf=document.getElementById("cpfInput").value.replace(/\D/g,"");
  if(!validarCPF(cpf)){alert("CPF inválido.");return;}
  startFakeProgress();
  const res=await fJSON(GET_ENDPOINT);
  if(!res){alert("Erro ao consultar dados.");return;}
  const cod=res.codigo||res.cursos||[];
  const norm=v=>v?v.toString().replace(/\D/g,"").padStart(11,"0"):"";
  const aluno=cod.find(r=>norm(getFieldIgnoreCase(r,"CPF2","CPF"))===cpf);
  if(!aluno){alert("CPF não encontrado no sistema.");return;}
  const cv=getFieldIgnoreCase(aluno,"CODIGO","Codigo","codigo");
  if(!cv){alert("CPF encontrado, mas sem mapa associado.");return;}
  const curso=cv.toString().trim().toUpperCase();
  const onibus=courseBusMap[curso]||"0046";
  sessionStorage.setItem("cpf",cpf);
  sessionStorage.setItem("curso",curso);
  sessionStorage.setItem("onibus",onibus);
  finishProgress();
  setTimeout(()=>{window.location.href="mapa/";},400);
};
</script>
</body>
</html>
